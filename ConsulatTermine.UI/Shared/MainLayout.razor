@inherits LayoutComponentBase
@using MudBlazor
@using ConsulatTermine.UI.Theme
@using ConsulatTermine.UI.Authentication

@inject EmployeeSessionService EmployeeSession

<MudThemeProvider Theme="AlgeriaTheme.DefaultTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

    <!-- APP BAR -->
    <MudAppBar Elevation="0"
               Color="Color.Primary"
               Class="consulate-appbar">

        <div class="consulate-appbar-inner">
            <img src="images/Alg_Logo.png"
                 alt="Consulat Algérien"
                 class="consulate-logo" />

            <div class="consulate-title">
                Consulat Général Algérien à Francfort
            </div>
        </div>

    </MudAppBar>

    <!-- EMPLOYEE NAV -->
    @if (_showEmployeeNav)
    {
        <MudDrawer Open="true"
                   Variant="DrawerVariant.Persistent"
                   Anchor="Anchor.Left"
                   Width="260px">

            <NavMenu />

        </MudDrawer>
    }

    <!-- CONTENT -->
    <MudMainContent Style="@MainContentStyle">
        @Body
    </MudMainContent>

</MudLayout>

@code {
    private bool _showEmployeeNav;

    private string MainContentStyle =>
        _showEmployeeNav
            ? "margin-top:88px; margin-left:260px;"
            : "margin-top:88px;";

    protected override void OnInitialized()
    {
        EmployeeSession.OnChange += HandleSessionChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var result = await EmployeeSession.EnsureAuthenticatedAsync();
        _showEmployeeNav = result.IsAuthenticated;

        StateHasChanged();
    }

    private void HandleSessionChanged()
    {
        _showEmployeeNav = EmployeeSession.IsAuthenticated;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        EmployeeSession.OnChange -= HandleSessionChanged;
    }
}
