@inherits LayoutComponentBase
@using MudBlazor
@using ConsulatTermine.UI.Theme
@using ConsulatTermine.UI.Authentication

@inject EmployeeSessionService EmployeeSession

<MudThemeProvider Theme="AlgeriaTheme.DefaultTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

    <!-- TOP BAR (für Bürger + Mitarbeiter identisch) -->
    <MudAppBar Elevation="4"
               Color="Color.Primary"
               Style="height: 120px; padding-top: 16px; margin-bottom: 50px;">
        <div class="d-flex justify-center align-center" style="width:100%; padding: 40px 0;">
            <MudImage Src="images/Alg_Logo.png"
                      Alt="Consulat Algerien Logo"
                      Style="height:90px; margin:12px;" />
            <MudText Typo="Typo.h3" Class="mud-text-white">
                Consulat Général Algérien à Francfort
            </MudText>
        </div>
    </MudAppBar>

    <!-- LEFT NAV (NUR für eingeloggte Mitarbeiter) -->
    @if (_showEmployeeNav)
    {
        <MudDrawer Open="true"
                   Elevation="1"
                   ClipMode="DrawerClipMode.Never"
                   Variant="DrawerVariant.Persistent"
                   Anchor="Anchor.Left"
                   Width="260px">

            <NavMenu />

        </MudDrawer>
    }

    <!-- MAIN CONTENT -->
   <MudMainContent Class="pa-0" Style="@MainContentStyle">
    @Body
</MudMainContent>


</MudLayout>


@code {
    private bool _showEmployeeNav;

    private string MainContentStyle =>
        _showEmployeeNav
            ? "margin-top:120px; margin-left:260px;"
            : "margin-top:120px;";

    protected override void OnInitialized()
    {
        // ❗ KEIN async / KEIN JS
        EmployeeSession.OnChange += HandleSessionChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        // ✅ JS ist JETZT erlaubt
        var result = await EmployeeSession.EnsureAuthenticatedAsync();
        _showEmployeeNav = result.IsAuthenticated;

        StateHasChanged();
    }

    private void HandleSessionChanged()
    {
        _showEmployeeNav = EmployeeSession.IsAuthenticated;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        EmployeeSession.OnChange -= HandleSessionChanged;
    }
}



