@page "/admin/services"

@using ConsulatTermine.Domain.Enums
@using ConsulatTermine.UI.Authentication
@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Domain.Entities

@inject IDialogService DialogService
@inject IServiceService ServiceService
@inject ISnackbar Snackbar
@inject EmployeeSessionService EmployeeSession
@inject NavigationManager Navigation

<MudPaper Class="pa-4">

    <MudStack Spacing="2">

        <!-- Header -->
        <MudStack Direction="Row"
                  Justify="Justify.SpaceBetween"
                  AlignItems="AlignItems.Center">

            <MudText Typo="Typo.h5">Service-Verwaltung</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@NewService">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="me-2" />
                Neuer Service
            </MudButton>
        </MudStack>

        <!-- Ladeanzeige -->
        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="mt-4">
                <MudProgressCircular Indeterminate="true" />
                <MudText Class="mt-2">Lade Services...</MudText>
            </MudStack>
        }
        else
        {
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }

            <!-- Tabelle -->
            <MudTable Items="_services" Hover="true" Dense="true">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Beschreibung</MudTh>
                    <MudTh>Etage</MudTh>
                    <MudTh>Slotdauer</MudTh>
                    <MudTh>Aktionen</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd>@context.Id</MudTd>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>@context.Description</MudTd>
                    <MudTd>@context.Floor</MudTd>
                    <MudTd>@context.SlotDurationMinutes</MudTd>

                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       OnClick="@(() => EditService(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Class="ms-1"
                                       OnClick="@(() => ConfirmDeleteService(context))" />
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText>Keine Services vorhanden.</MudText>
                </NoRecordsContent>
            </MudTable>
        }

        <!-- Formular -->
        @if (_editOpen)
        {
            <MudPaper Class="pa-4 mt-4">

                <MudText Typo="Typo.h6" Class="mb-2">
                    @(_editId == 0 ? "Neuen Service anlegen" : "Service bearbeiten")
                </MudText>

                <EditForm Model="_model"
                          OnValidSubmit="SaveAsync"
                          OnInvalidSubmit="OnInvalidSubmit">
                    <DataAnnotationsValidator />

                    <MudStack Spacing="2">

                        <MudTextField Label="Name"
                                      Required="true"
                                      @bind-Value="_model.Name" />

                        <MudTextField Label="Beschreibung"
                                      Lines="3"
                                      TextArea="true"
                                      @bind-Value="_model.Description" />

                        <MudTextField Label="Etage (z. B. EG, 1. OG)"
                                      Required="true"
                                      @bind-Value="_model.Floor" />

                        <MudNumericField Label="Slotdauer (Minuten)"
                                         Min="1"
                                         Required="true"
                                         @bind-Value="_model.SlotDurationMinutes" />


                        @if (!string.IsNullOrEmpty(_formError))
                        {
                            <MudAlert Severity="Severity.Error">@_formError</MudAlert>
                        }

                        <MudStack Direction="Row" Justify="Justify.FlexEnd" Spacing="2">
                            <MudButton Variant="Variant.Text" OnClick="@CancelEdit">
                                Abbrechen
                            </MudButton>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="_saving"
                                       ButtonType="ButtonType.Submit">
                                Speichern
                            </MudButton>
                        </MudStack>

                    </MudStack>
                </EditForm>

            </MudPaper>
        }

    </MudStack>

</MudPaper>

@code {

    private List<Service> _services = new();
    private bool _loading = true;

    private bool _editOpen;
    private int _editId;
    private ServiceDto _model = new();

    private bool _saving;
    private string? _errorMessage;
    private string? _formError;

    // -------------------- AUTH GUARD --------------------
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var auth = await EmployeeSession.EnsureAuthenticatedAsync();
        if (!auth.IsAuthenticated)
        {
            Navigation.NavigateTo("/employee/login", true);
            return;
        }

        if (EmployeeSession.CurrentRole != EmployeeRole.Admin)
        {
            Navigation.NavigateTo("/employee/home", true);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        await LoadServices();
    }

    private async Task LoadServices()
    {
        _loading = true;
        _services = await ServiceService.GetAllServicesAsync();
        _loading = false;
    }

    private void NewService()
    {
        _model = new ServiceDto
        {
            Name = "",
            Description = "",
            Floor = "",
            SlotDurationMinutes = 10
        };

        _editId = 0;
        _editOpen = true;
    }

    private void EditService(Service s)
    {
        _model = new ServiceDto
        {
            Name = s.Name,
            Description = s.Description,
            Floor = s.Floor,
            SlotDurationMinutes = s.SlotDurationMinutes,
            CapacityPerSlot = s.CapacityPerSlot
        };

        _editId = s.Id;
        _editOpen = true;
    }

    private void CancelEdit()
    {
        _editOpen = false;
        _formError = null;
    }

    private async Task OnInvalidSubmit()
    {
        _formError = "Bitte alle Pflichtfelder ausfüllen.";
    }

private async Task SaveAsync()
{
    _saving = true;

    try
    {
        var isCreate = _editId == 0;

        if (isCreate)
            await ServiceService.CreateServiceAsync(_model);
        else
            await ServiceService.UpdateServiceAsync(_editId, _model);

        _editOpen = false;
        await LoadServices();

        Snackbar.Add(
            isCreate
                ? $"Service \"{_model.Name}\" wurde erfolgreich angelegt."
                : $"Service \"{_model.Name}\" wurde erfolgreich aktualisiert.",
            Severity.Success);
    }
    catch (Exception ex)
    {
        Snackbar.Add(
            ex.Message,
            Severity.Error);

        Console.Error.WriteLine(ex);
    }
    finally
    {
        _saving = false;
    }
}


    private async Task ConfirmDeleteService(Service s)
{
    var parameters = new DialogParameters
    {
        ["Title"] = "Service löschen",
        ["Message"] =
            $"Möchtest du den Service **{s.Name}** wirklich löschen?"
    };

    var dialog = await DialogService.ShowAsync<ConfirmDeleteDialog>(
        "Bestätigung",
        parameters);

    var result = await dialog.Result;

    if (result is { Canceled: false })
    {
        await DeleteService(s); // ✅ EXISTIERENDE Methode
    }
}


  private async Task DeleteService(Service s)
{
    try
    {
        await ServiceService.DeleteServiceAsync(s.Id);
        await LoadServices();

        Snackbar.Add(
            $"Service \"{s.Name}\" wurde erfolgreich gelöscht.",
            Severity.Success);
    }
    catch (Exception ex)
    {
        Snackbar.Add(
            ex.Message,
            Severity.Error);

        Console.Error.WriteLine(ex);
    }
}

}
