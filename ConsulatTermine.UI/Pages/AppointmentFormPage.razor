@page "/appointment-form"

@using ConsulatTermine.Application.ViewModels
@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using Blazored.SessionStorage
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Domain.Entities

@inject IAppointmentService AppointmentService
@inject IServiceService ServiceService
@inject NavigationManager Navigation
@inject ISessionStorageService Session


@using System.ComponentModel.DataAnnotations
@inject ISessionStorageService Session
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="mx-auto mt-8">

    <MudStepper Elevation="0" Class="mb-6">
        <MudStep Label="1. Services" Completed="true" />
        <MudStep Label="2. Termine" Completed="true" />
        <MudStep Label="3. Formular" />
        <MudStep Label="4. Bestätigung" />
    </MudStepper>

    <MudCard Class="pa-6" Style="box-shadow:0px 8px 18px rgba(0,0,0,0.10); border-radius:12px;">

        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
            Persönliche Angaben & Slot-Zuweisung
        </MudText>

        <EditForm Model="@_formModel" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />

            @for (int i = 0; i < _formModel.Persons.Count; i++)
            {
                var person = _formModel.Persons[i];
                <MudPaper Class="pa-4 mb-4" Style="border:1px solid #ccc; border-radius:8px;">

                    <MudText Typo="Typo.h6">Person @((i+1))</MudText>

                    <MudTextField @bind-Value="person.FirstName"
                                  Label="Vorname *"
                                  For="@(() => person.FirstName)"
                                  Required="true"
                                  RequiredError="Vorname ist erforderlich!" />

                    <MudTextField @bind-Value="person.LastName"
                                  Label="Nachname *"
                                  For="@(() => person.LastName)"
                                  Required="true"
                                  RequiredError="Nachname ist erforderlich!" />

                    <MudDatePicker @bind-Date="person.DateOfBirth"
                                   Label="Geburtsdatum *"
                                   For="@(() => person.DateOfBirth)"
                                   Required="true"
                                   RequiredError="Geburtsdatum ist erforderlich!" />

                    <MudTextField @bind-Value="person.Email"
                                  Label="E-Mail *"
                                  For="@(() => person.Email)"
                                  Required="true"
                                  RequiredError="E-Mail ist erforderlich!"
                                  Immediate="true" />

                    <MudTextField @bind-Value="person.Phone"
                                  Label="Telefon *"
                                  For="@(() => person.Phone)"
                                  Required="true"
                                  RequiredError="Telefon ist erforderlich!" />

                    <MudDivider Class="my-3" />

                    <!-- Slot-Zuweisung für jeden Service -->
                    @foreach (var svc in _services)
                    {
                        <MudText Typo="Typo.subtitle1">
                            Slot für Service: @svc.Name
                        </MudText>

                        <MudSelect T="DateTime"
                                   Label="Slot wählen *"
                                   Required="true"
                                   RequiredError="Bitte wähle einen Slot"
                                   @bind-Value="person.SelectedSlots[svc.Id]">

                            @foreach (var slot in _slotsByService[svc.Id])
                            {
                                <MudSelectItem Value="slot.DateTime">
                                    @slot.DisplayDate - @slot.DisplayTime
                                </MudSelectItem>
                            }
                        </MudSelect>
                    }

                </MudPaper>
            }

            <MudButton Color="Color.Primary" Variant="Variant.Filled" Type="Submit">
                Termin absenden
            </MudButton>

        </EditForm>

    </MudCard>
</MudContainer>

@code {

    // Form Model
    private AppointmentFormModel _formModel = new();

    // Services & Slots
    private List<ServiceDto> _services = new();
    private Dictionary<int,List<SlotViewModel>> _slotsByService = new();

    protected override async Task OnInitializedAsync()
    {
        // Session lesen
        var assignments = await Session.GetItemAsync<Dictionary<int,int>>("serviceAssignments");
        if (assignments == null || assignments.Count == 0)
        {
            Navigation.NavigateTo("/services");
            return;
        }

        // Personen laden
        var personCount = await Session.GetItemAsync<int>("personCount");
        _formModel.Persons = new List<PersonFormModel>();
        for (int i = 0; i < personCount; i++)
            _formModel.Persons.Add(new PersonFormModel());

        // Services und Slots laden
        _services = new List<ServiceDto>();
        foreach (var sid in assignments.Keys)
        {
            var svc = await Session.GetItemAsync<ServiceDto>($"service_{sid}");
            if (svc == null)
            {
                Navigation.NavigateTo("/services");
                return;
            }
            _services.Add(svc);

            // Slots aus Session holen
            var slotDict = await Session.GetItemAsync<Dictionary<DateTime,int>>($"slots_{sid}");
            var flatSlots = slotDict?.Keys.OrderBy(d => d).ToList() ?? new List<DateTime>();
            _slotsByService[sid] = flatSlots
                .Select(dt => new SlotViewModel { DateTime = dt })
                .ToList();
        }

        // Vorbereiten der Slot Arrays in jedem PersonModel
        foreach (var p in _formModel.Persons)
        {
            p.SelectedSlots = new Dictionary<int, DateTime>();
            foreach (var svc in _services)
            {
                p.SelectedSlots[svc.Id] = default;
            }
        }
    }

    // Wenn Form gültig abgesendet wird
    private async Task OnValidSubmit()
    {
        // Hier kannst du die Daten jetzt an dein Backend senden
        // oder lokal weiterspeichern bevor finaler Submit

        // Beispiel: debug output
        Console.WriteLine("Form valid!");
        foreach (var p in _formModel.Persons)
        {
            Console.WriteLine($"Person {p.FirstName} {p.LastName} - Slots:");
            foreach (var svc in _services)
                Console.WriteLine($" Service {svc.Name}: {p.SelectedSlots[svc.Id]}");
        }

        // Weiter zur Bestätigungsseite
        Navigation.NavigateTo("/appointment-confirmation");
    }

    // Form Models

    public class AppointmentFormModel
    {
        public List<PersonFormModel> Persons { get; set; } = new();
    }

    public class PersonFormModel
    {
        [Required] public string FirstName { get; set; } = string.Empty;
        [Required] public string LastName { get; set; } = string.Empty;
        [Required] public DateTime? DateOfBirth { get; set; }
        [Required][EmailAddress] public string Email { get; set; } = string.Empty;
        [Required] public string Phone { get; set; } = string.Empty;

        // Slot Auswahl pro ServiceId
        public Dictionary<int, DateTime> SelectedSlots { get; set; } = new();
    }
}

