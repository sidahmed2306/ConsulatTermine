@page "/appointment-form"

@using ConsulatTermine.Application.DTOs.Booking
@using ConsulatTermine.Application.Interfaces.Booking
@using MudBlazor
@using Blazored.SessionStorage
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Application.Interfaces
@using System.ComponentModel.DataAnnotations

@inject IServiceService ServiceService
@inject IBookingService BookingService
@inject NavigationManager Navigation
@inject ISessionStorageService Session
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mx-auto mt-8">

    <MudStepper Elevation="0" Class="mb-6">
        <MudStep Label="1. Services" Completed="true" />
        <MudStep Label="2. Termine" Completed="true" />
        <MudStep Label="3. Formular" />
        <MudStep Label="4. Best√§tigung" />
    </MudStepper>

    <MudCard Class="pa-6" Style="border-radius:12px;">

        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
            Pers√∂nliche Angaben
        </MudText>

        <EditForm Model="_formModel" OnValidSubmit="OnValidSubmit"   OnInvalidSubmit="OnInvalidSubmit">
            <DataAnnotationsValidator />

            <MudExpansionPanels MultiExpansion="true">

                @for (int i = 0; i < _formModel.Persons.Count; i++)
{
    var person = _formModel.Persons[i];
    var personNumber = i + 1;   

    <MudExpansionPanel @key="personNumber" Expanded="@(personNumber == 1)">
        <TitleContent>
            <MudText Typo="Typo.h6">Person @personNumber</MudText>
        </TitleContent>

        <ChildContent>

            <MudTextField @bind-Value="person.FirstName"
                          Label="Vorname *"
                          Required="true" />

            <MudTextField @bind-Value="person.LastName"
                          Label="Nachname *"
                          Required="true" />

            <MudDatePicker @bind-Date="person.DateOfBirth"
                           Label="Geburtsdatum *"
                           Required="true" />

            <MudTextField @bind-Value="person.Email"
                          Label="E-Mail *"
                          Required="true" />

            <MudTextField @bind-Value="person.Phone"
                          Label="Telefon *"
                          Required="true" />

            <MudDivider Class="my-3" />

            @foreach (var svc in _services)
            {
               @if (_slotsByService[svc.Id].Any())
{
    <MudText Typo="Typo.subtitle1" Class="mt-2 mb-1">
        Slot f√ºr Service: @svc.Name
    </MudText>

    <MudGrid Spacing="2">
        @foreach (var slot in _slotsByService[svc.Id]
            .Where(s =>
                !_formModel.Persons
                    .Where(p => p != person)
                    .Select(p => p.SelectedSlots[svc.Id])
                    .Contains(s.DateTime)))
        {
            var isSelected = person.SelectedSlots[svc.Id] == slot.DateTime;

            <MudItem xs="12" sm="6" md="4">
               <MudButton
    Variant="@(isSelected ? Variant.Filled : Variant.Outlined)"
    Color="@(isSelected ? Color.Success : Color.Default)"
    FullWidth="true"
    Style="
        border-radius: 999px;
        height: 64px;
        padding: 0;
        text-transform: none;
        font-weight: 500;"
    OnClick="@(() => SelectSlot(person, svc.Id, slot.DateTime))">

    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="0">
        <MudText Typo="Typo.h6" Style="line-height:1;">
            @slot.DateTime.ToString("HH:mm")
        </MudText>

        <MudText Typo="Typo.caption" Style="opacity:.75;">
            @slot.DateTime.ToString("dd.MM.yyyy")
        </MudText>
    </MudStack>

</MudButton>

            </MudItem>
        }
    </MudGrid>
}

            }

        </ChildContent>
    </MudExpansionPanel>
}


            </MudExpansionPanels>

            <MudDivider Class="my-4" />

            <MudButton Color="Color.Success"
                       Variant="Variant.Filled"
                       ButtonType="ButtonType.Submit"
                       FullWidth="true">
                Termin absenden
            </MudButton>

        </EditForm>

    </MudCard>
</MudContainer>

@code {

    private AppointmentFormModel _formModel = new();
    private List<ServiceDto> _services = new();
    private Dictionary<int, List<SlotViewModel>> _slotsByService = new();
    private bool _initialized;

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (!firstRender || _initialized)
        return;

    _initialized = true;

    var selectedServiceSlots =
        await Session.GetItemAsync<Dictionary<int, List<DateTime>>>("selectedServiceSlots");

    if (selectedServiceSlots == null || selectedServiceSlots.Count == 0)
    {
        Navigation.NavigateTo("/services");
        return;
    }

    var personCount = await Session.GetItemAsync<int>("personCount");
    if (personCount <= 0)
    {
        Navigation.NavigateTo("/services");
        return;
    }

    // üëâ ab hier DEIN bestehender Code:
    _formModel.Persons = new();
    for (int i = 0; i < personCount; i++)
        _formModel.Persons.Add(new PersonFormModel());

    _services = new();
    _slotsByService = new();

    foreach (var kvp in selectedServiceSlots)
    {
        var svc = await ServiceService.GetByIdAsync(kvp.Key);
        _services.Add(svc);

        _slotsByService[kvp.Key] = kvp.Value
            .OrderBy(d => d)
            .Select(d => new SlotViewModel { DateTime = d })
            .ToList();
    }

    foreach (var p in _formModel.Persons)
    {
        p.SelectedSlots = new();
        foreach (var svc in _services)
            p.SelectedSlots[svc.Id] = default;
    }

    StateHasChanged();
}

    protected override  Task OnInitializedAsync()
    {
       return Task.CompletedTask;
    }

    private void OnInvalidSubmit()
{
    Snackbar.Add(
        "Bitte f√ºllen Sie alle erforderlichen Felder korrekt aus.",
        Severity.Error);
}


  private async Task OnValidSubmit()
{
    // Zus√§tzliche Slot-Validierung
    if (!AreAllSlotsSelected(out var error))
    {
        Snackbar.Add(error, Severity.Error);
        return;
    }

    try
    {
        var request = new CreateBookingRequestDto();

        // =========================
        // Hauptperson (PersonIndex = 1)
        // => immer Person[0]
        // =========================
        var mainPersonForm = _formModel.Persons[0];

        request.MainPerson = new BookingPersonDto
        {
            FullName = $"{mainPersonForm.FirstName} {mainPersonForm.LastName}",
            Email = mainPersonForm.Email,
            PhoneNumber = mainPersonForm.Phone,
            DateOfBirth = mainPersonForm.DateOfBirth
        };

        foreach (var service in _services)
{
    var slot = mainPersonForm.SelectedSlots[service.Id];

    if (slot != default)
    {
        request.MainPerson.ServiceSlots.Add(new BookingServiceSlotDto
        {
            ServiceId = service.Id,
            SlotTime = slot
        });
    }
}


        // =========================
        // Begleitpersonen (PersonIndex = 2..n)
        // =========================
        for (int i = 1; i < _formModel.Persons.Count; i++)
        {
            var p = _formModel.Persons[i];

            var personDto = new BookingPersonDto
            {
                FullName = $"{p.FirstName} {p.LastName}",
                PhoneNumber = p.Phone,
                DateOfBirth = p.DateOfBirth
            };

            foreach (var service in _services)
{
    var slot = p.SelectedSlots[service.Id];

    if (slot != default)
    {
        personDto.ServiceSlots.Add(new BookingServiceSlotDto
        {
            ServiceId = service.Id,
            SlotTime = slot
        });
    }
}


            request.AccompanyingPersons.Add(personDto);
        }

        // =========================
        // BACKEND CALL
        // =========================
        var bookingReference = await BookingService.CreateBookingAsync(request);

        // optional: Buchungsreferenz speichern
        await Session.SetItemAsync("bookingReference", bookingReference);

        Navigation.NavigateTo("/appointment-confirmation");
    }
    catch (Exception ex)
    {
        Snackbar.Add(ex.Message, Severity.Error);
    }
}



    // Models

    public class AppointmentFormModel
    {
        public List<PersonFormModel> Persons { get; set; } = new();
    }

private bool AreAllSlotsSelected(out string errorMessage)
{
    foreach (var svc in _services)
    {
        var hasAtLeastOneSlot = _formModel.Persons
            .Any(p =>
                p.SelectedSlots.TryGetValue(svc.Id, out var slot)
                && slot != default);

        if (!hasAtLeastOneSlot)
        {
            errorMessage = $"Bitte w√§hlen Sie einen Termin f√ºr den Service '{svc.Name}'.";
            return false;
        }
    }

    errorMessage = string.Empty;
    return true;
}


  private void SelectSlot(PersonFormModel person, int serviceId, DateTime dateTime)
{
    // Wenn Key nicht existiert -> anlegen
    if (!person.SelectedSlots.ContainsKey(serviceId))
        person.SelectedSlots[serviceId] = default;

    // Toggle: wenn derselbe Slot nochmal geklickt wird => abw√§hlen
    if (person.SelectedSlots[serviceId] == dateTime)
    {
        person.SelectedSlots[serviceId] = default; // oder DateTime.MinValue
        Console.WriteLine($"[Slot] UNSELECT Person -> Service {serviceId} Slot {dateTime:dd.MM.yyyy HH:mm}");
        return;
    }

    // sonst normal ausw√§hlen
    person.SelectedSlots[serviceId] = dateTime;
    Console.WriteLine($"[Slot] SELECT Person -> Service {serviceId} Slot {dateTime:dd.MM.yyyy HH:mm}");
}



    public class PersonFormModel
    {
        [Required] public string FirstName { get; set; } = "";
        [Required] public string LastName { get; set; } = "";
        [Required] public DateTime? DateOfBirth { get; set; }
        [Required] public string Email { get; set; } = "";
        [Required] public string Phone { get; set; } = "";

        public Dictionary<int, DateTime> SelectedSlots { get; set; } = new();
    }

    public class SlotViewModel
    {
        public DateTime DateTime { get; set; }
        public string DisplayDate => DateTime.ToString("dd.MM.yyyy");
        public string DisplayTime => DateTime.ToString("HH:mm");
    }
}
