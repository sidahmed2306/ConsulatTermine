@page "/appointment-form"

@using ConsulatTermine.Application.DTOs.Booking
@using ConsulatTermine.Application.Interfaces.Booking
@using MudBlazor
@using Blazored.SessionStorage
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Application.Interfaces
@using System.ComponentModel.DataAnnotations

@inject IServiceService ServiceService
@inject IBookingService BookingService
@inject NavigationManager Navigation
@inject ISessionStorageService Session
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mx-auto mt-8">

    <MudStepper Elevation="0" Class="mb-6">
        <MudStep Label="1. Services" Completed="true" />
        <MudStep Label="2. Termine" Completed="true" />
        <MudStep Label="3. Formular" />
        <MudStep Label="4. Bestätigung" />
    </MudStepper>

    <MudCard Class="pa-6" Style="border-radius:12px;">

        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
            Persönliche Angaben
        </MudText>

        <EditForm Model="_formModel" OnValidSubmit="OnValidSubmit" OnInvalidSubmit="OnInvalidSubmit">
            <DataAnnotationsValidator />

            <MudExpansionPanels MultiExpansion="true">

                @for (int i = 0; i < _formModel.Persons.Count; i++)
                {
                    var person = _formModel.Persons[i];
                    var personNumber = i + 1;

                    <MudExpansionPanel @key="personNumber" Expanded="@(personNumber == 1)">
                        <TitleContent>
                            <MudText Typo="Typo.h6">Person @personNumber</MudText>
                        </TitleContent>

                        <ChildContent>

                            <MudTextField @bind-Value="person.FirstName"
                                          Label="Vorname *"
                                          Required="true" />

                            <MudTextField @bind-Value="person.LastName"
                                          Label="Nachname *"
                                          Required="true" />

                            <MudDatePicker @bind-Date="person.DateOfBirth"
                                           Label="Geburtsdatum *"
                                           Required="true" />

                            <MudTextField @bind-Value="person.Email"
                                          Label="E-Mail *"
                                          Required="true" />

                            <MudTextField @bind-Value="person.Phone"
                                          Label="Telefon *"
                                          Required="true" />

                            <MudDivider Class="my-3" />

                            @foreach (var svc in _services)
                            {
                                if (_slotsByService.TryGetValue(svc.Id, out var svcSlots) && svcSlots.Any())
                                {
                                    <MudText Typo="Typo.subtitle1" Class="mt-2 mb-1">
                                        Slot für Service: @svc.Name
                                    </MudText>

                                    // ----------------------------
                                    // ✅ KAPAZITÄTSLOGIK:
                                    // Duplikate = Kapazität (z.B. 2x 09:00)
                                    // ----------------------------

                                    person.SelectedSlots.TryGetValue(svc.Id, out var selectedForThisPerson);

                                    var groupedByTime = svcSlots
                                        .GroupBy(s => s.DateTime)
                                        .OrderBy(g => g.Key);

                                    <MudGrid Spacing="2">

                                        @foreach (var group in groupedByTime)
                                        {
                                            var time = group.Key;
                                            var totalCapacity = group.Count();

                                            // wie viele ANDERE Personen haben diese Uhrzeit bereits gewählt?
                                            var takenByOthers = _formModel.Persons
                                                .Where(p => p != person)
                                                .Count(p =>
                                                {
                                                    p.SelectedSlots.TryGetValue(svc.Id, out var otherSlot);
                                                    return otherSlot == time;
                                                });

                                            // verbleibende Kapazität für diese Person
                                            var remaining = Math.Max(0, totalCapacity - takenByOthers);

                                            // ✅ Wenn diese Person schon gewählt hat:
                                            // Dann nur den ausgewählten Slot anzeigen (genau 1x)
                                            if (selectedForThisPerson != default)
                                            {
                                                if (selectedForThisPerson == time)
                                                {
                                                    <MudItem xs="12" sm="6" md="4">
                                                        <MudButton
                                                            Variant="Variant.Filled"
                                                            Color="Color.Success"
                                                            FullWidth="true"
                                                            Style="
                                                                border-radius: 999px;
                                                                height: 64px;
                                                                padding: 0;
                                                                text-transform: none;
                                                                font-weight: 500;"
                                                            OnClick="@(() => SelectSlot(person, svc.Id, time))">

                                                            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="0">
                                                                <MudText Typo="Typo.h6" Style="line-height:1;">
                                                                    @time.ToString("HH:mm")
                                                                </MudText>

                                                                <MudText Typo="Typo.caption" Style="opacity:.75;">
                                                                    @time.ToString("dd.MM.yyyy")
                                                                </MudText>
                                                            </MudStack>

                                                        </MudButton>
                                                    </MudItem>
                                                }

                                                continue;
                                            }

                                            // ✅ Wenn diese Person noch NICHT gewählt hat:
                                            // Zeit so oft anzeigen wie verbleibende Kapazität
                                            for (int k = 0; k < remaining; k++)
                                            {
                                                <MudItem xs="12" sm="6" md="4" @key="@(time.ToString("O") + "-" + k + "-" + personNumber)">
                                                    <MudButton
                                                        Variant="Variant.Outlined"
                                                        Color="Color.Default"
                                                        FullWidth="true"
                                                        Style="
                                                            border-radius: 999px;
                                                            height: 64px;
                                                            padding: 0;
                                                            text-transform: none;
                                                            font-weight: 500;"
                                                        OnClick="@(() => SelectSlot(person, svc.Id, time))">

                                                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="0">
                                                            <MudText Typo="Typo.h6" Style="line-height:1;">
                                                                @time.ToString("HH:mm")
                                                            </MudText>

                                                            <MudText Typo="Typo.caption" Style="opacity:.75;">
                                                                @time.ToString("dd.MM.yyyy")
                                                            </MudText>
                                                        </MudStack>

                                                    </MudButton>
                                                </MudItem>
                                            }
                                        }

                                    </MudGrid>
                                }
                            }

                        </ChildContent>
                    </MudExpansionPanel>
                }

            </MudExpansionPanels>

            <MudDivider Class="my-4" />

            <MudButton Color="Color.Success"
                       Variant="Variant.Filled"
                       ButtonType="ButtonType.Submit"
                       FullWidth="true">
                Termin absenden
            </MudButton>

        </EditForm>

    </MudCard>
</MudContainer>

@code {

    private AppointmentFormModel _formModel = new();
    private List<ServiceDto> _services = new();
    private Dictionary<int, List<SlotViewModel>> _slotsByService = new();
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized)
            return;

        _initialized = true;

        var selectedServiceSlots =
            await Session.GetItemAsync<Dictionary<int, List<DateTime>>>("selectedServiceSlots");

        if (selectedServiceSlots == null || selectedServiceSlots.Count == 0)
        {
            Navigation.NavigateTo("/services");
            return;
        }

        var personCount = await Session.GetItemAsync<int>("personCount");
        if (personCount <= 0)
        {
            Navigation.NavigateTo("/services");
            return;
        }

        _formModel.Persons = new();
        for (int i = 0; i < personCount; i++)
            _formModel.Persons.Add(new PersonFormModel());

        _services = new();
        _slotsByService = new();

        foreach (var kvp in selectedServiceSlots)
        {
            var svc = await ServiceService.GetByIdAsync(kvp.Key);
            _services.Add(svc);

            // ❗ Wichtig: KEIN Distinct(), weil Duplikate Kapazität bedeuten
            _slotsByService[kvp.Key] = kvp.Value
                .OrderBy(d => d)
                .Select(d => new SlotViewModel { DateTime = d })
                .ToList();
        }

        foreach (var p in _formModel.Persons)
        {
            p.SelectedSlots = new();
            foreach (var svc in _services)
                p.SelectedSlots[svc.Id] = default;
        }

        StateHasChanged();
    }

    protected override Task OnInitializedAsync()
    {
        return Task.CompletedTask;
    }

    private void OnInvalidSubmit()
    {
        Snackbar.Add(
            "Bitte füllen Sie alle erforderlichen Felder korrekt aus.",
            Severity.Error);
    }

    private async Task OnValidSubmit()
    {
        // Zusätzliche Slot-Validierung
        if (!AreAllSlotsSelected(out var error))
        {
            Snackbar.Add(error, Severity.Error);
            return;
        }

        try
        {
            var request = new CreateBookingRequestDto();

            // =========================
            // Hauptperson (PersonIndex = 1)
            // => immer Person[0]
            // =========================
            var mainPersonForm = _formModel.Persons[0];

            request.MainPerson = new BookingPersonDto
            {
                FullName = $"{mainPersonForm.FirstName} {mainPersonForm.LastName}",
                Email = mainPersonForm.Email,
                PhoneNumber = mainPersonForm.Phone,
                DateOfBirth = mainPersonForm.DateOfBirth
            };

            foreach (var service in _services)
            {
                var slot = mainPersonForm.SelectedSlots[service.Id];

                if (slot != default)
                {
                    request.MainPerson.ServiceSlots.Add(new BookingServiceSlotDto
                    {
                        ServiceId = service.Id,
                        SlotTime = slot
                    });
                }
            }

            // =========================
            // Begleitpersonen (PersonIndex = 2..n)
            // =========================
            for (int i = 1; i < _formModel.Persons.Count; i++)
            {
                var p = _formModel.Persons[i];

                var personDto = new BookingPersonDto
                {
                    FullName = $"{p.FirstName} {p.LastName}",
                    PhoneNumber = p.Phone,
                    DateOfBirth = p.DateOfBirth
                };

                foreach (var service in _services)
                {
                    var slot = p.SelectedSlots[service.Id];

                    if (slot != default)
                    {
                        personDto.ServiceSlots.Add(new BookingServiceSlotDto
                        {
                            ServiceId = service.Id,
                            SlotTime = slot
                        });
                    }
                }

                request.AccompanyingPersons.Add(personDto);
            }

            // =========================
            // BACKEND CALL
            // =========================
            var bookingReference = await BookingService.CreateBookingAsync(request);

            await Session.SetItemAsync("bookingReference", bookingReference);

            Navigation.NavigateTo("/appointment-confirmation");
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    public class AppointmentFormModel
    {
        public List<PersonFormModel> Persons { get; set; } = new();
    }

    private bool AreAllSlotsSelected(out string errorMessage)
    {
        foreach (var svc in _services)
        {
            var hasAtLeastOneSlot = _formModel.Persons
                .Any(p =>
                    p.SelectedSlots.TryGetValue(svc.Id, out var slot)
                    && slot != default);

            if (!hasAtLeastOneSlot)
            {
                errorMessage = $"Bitte wählen Sie einen Termin für den Service '{svc.Name}'.";
                return false;
            }
        }

        errorMessage = string.Empty;
        return true;
    }

    private void SelectSlot(PersonFormModel person, int serviceId, DateTime dateTime)
    {
        if (!person.SelectedSlots.ContainsKey(serviceId))
            person.SelectedSlots[serviceId] = default;

        // Toggle: nochmal klicken = abwählen
        if (person.SelectedSlots[serviceId] == dateTime)
        {
            person.SelectedSlots[serviceId] = default;
            return;
        }

        person.SelectedSlots[serviceId] = dateTime;
    }

    public class PersonFormModel
    {
        [Required] public string FirstName { get; set; } = "";
        [Required] public string LastName { get; set; } = "";
        [Required] public DateTime? DateOfBirth { get; set; }
        [Required] public string Email { get; set; } = "";
        [Required] public string Phone { get; set; } = "";

        public Dictionary<int, DateTime> SelectedSlots { get; set; } = new();
    }

    public class SlotViewModel
    {
        public DateTime DateTime { get; set; }
        public string DisplayDate => DateTime.ToString("dd.MM.yyyy");
        public string DisplayTime => DateTime.ToString("HH:mm");
    }
}
