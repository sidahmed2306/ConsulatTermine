@page "/employee/select-service"

@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Application.Interfaces
@using MudBlazor

@inject IEmployeeService EmployeeService
@inject ConsulatTermine.UI.Authentication.EmployeeSessionService EmployeeSession

@inject NavigationManager Navigation


@inherits ConsulatTermine.UI.Authentication.EmployeeProtectedComponentBase


<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">

    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h5" Class="mb-4">Service ausw√§hlen</MudText>

        @if (_services.Count == 0)
        {
            <MudText Color="Color.Error">
                Ihnen sind aktuell keine Services zugeordnet.
            </MudText>
        }
        else
        {
            <MudStack Spacing="2">
                @foreach (var service in _services)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="() => SelectService(service.Id)">
                        @service.Name
                    </MudButton>
                }
            </MudStack>
        }
    </MudPaper>

</MudContainer>

@code {
    private List<Service> _services = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (!firstRender || CurrentEmployeeId <= 0)
            return;

        var employee = await EmployeeService.GetEmployeeByIdAsync(CurrentEmployeeId);
        if (employee != null)
        {
            _services = employee.AssignedServices
                .Select(a => a.Service)
                .Where(s => s != null)
                .Select(s => s!)
                .ToList();
        }

        StateHasChanged();
    }

   private async Task SelectService(int serviceId)
{
    await EmployeeSession.SetActiveServiceAsync(serviceId);
    Navigation.NavigateTo("/employee/dashboard");
}

}
