@page "/employee/login"
@inject NavigationManager Navigation
@inject ConsulatTermine.Application.Interfaces.IEmployeeAuthService AuthService
@inject ConsulatTermine.UI.Authentication.EmployeeSessionService EmployeeSession


@inject ConsulatTermine.Application.Interfaces.IEmployeeService EmployeeService
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Infrastructure.Services
@using ConsulatTermine.Domain.Entities

@using MudBlazor

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudCard>
        <MudCardContent>

            <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
                Mitarbeiter Login
            </MudText>

            <MudForm @ref="_form" @bind-IsValid="_isValid">
                <MudTextField T="string"
                              Label="Mitarbeiter-Kennung"
                              @bind-Value="_employeeCode"
                              Required="true"
                              RequiredError="Kennung ist erforderlich"
                              Variant="Variant.Outlined" />

                <MudTextField T="string"
                              Label="Passwort"
                              @bind-Value="_password"
                              InputType="@_passwordInputType"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              Required="true"
                              RequiredError="Passwort ist erforderlich"
                              Variant="Variant.Outlined"
                              Class="mt-4" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudText Color="Color.Error" Class="mt-2">@_errorMessage</MudText>
                }

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="!_isValid"
                           OnClick="PerformLogin"
                           Class="mt-6"
                           FullWidth="true">
                    Login
                </MudButton>
            </MudForm>

        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private MudForm? _form;
    private bool _isValid;

    private string _employeeCode = string.Empty;
    private string _password = string.Empty;
    private string _errorMessage = string.Empty;

    private bool _showPassword;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;

        if (_showPassword)
        {
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private async Task PerformLogin()
    {
        if (_form is null)
            return;

        await _form.Validate();

        if (!_isValid)
            return;

        _errorMessage = string.Empty;

        var result = await AuthService.LoginAsync(
            _employeeCode.Trim(),
            _password
        );

        if (!result.Success || result.EmployeeId == null)
        {
            _errorMessage = result.ErrorMessage ?? "Login fehlgeschlagen";
            return;
        }

      await EmployeeSession.SignInAsync(
    result.EmployeeId.Value,
    result.EmployeeCode!
);


        if (result.MustChangePassword)
        {
            Navigation.NavigateTo(
                $"/employee/change-password/{result.EmployeeId.Value}"
            );
            return;
        }

        var employee = await EmployeeService.GetEmployeeByIdAsync(
            result.EmployeeId.Value
        );

       var services = employee?.AssignedServices
    .Select(a => a.Service)
    .Where(s => s != null)
    .ToList()
    ?? new List<Service>();


        if (services.Count == 1)
        {
            Navigation.NavigateTo(
                $"/employee/dashboard/{services[0]!.Id}"
            );
        }
        else
        {
            Navigation.NavigateTo("/employee/select-service");
        }
    }
}
