@page "/employee/login"

@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.UI.Authentication

@inject NavigationManager Navigation
@inject IEmployeeAuthService AuthService
@inject EmployeeSessionService EmployeeSession
@inject IEmployeeService EmployeeService


<MudContainer MaxWidth="MaxWidth.False"
              Class="d-flex justify-center align-center"
              Style="min-height: calc(50vh - 120px);">

    <MudCard Class="login-card" Style="width:420px; margin-top:60px;">


        <MudCardContent>

           <MudText Typo="Typo.h4"
         Align="Align.Center"
         Class="mb-6"
         Color="Color.Primary">

                Mitarbeiter Login
            </MudText>

            <MudForm @ref="_form" @bind-IsValid="_isValid">
                <MudTextField T="string"
                              Label="Mitarbeiter-Kennung"
                              @bind-Value="_employeeCode"
                              Required="true"
                              RequiredError="Kennung ist erforderlich"
                              Variant="Variant.Outlined" />

                <MudTextField T="string"
                              Label="Passwort"
                              @bind-Value="_password"
                              InputType="@_passwordInputType"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              Required="true"
                              RequiredError="Passwort ist erforderlich"
                              Variant="Variant.Outlined"
                              Class="mt-4" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudText Color="Color.Error" Class="mt-2">
                        @_errorMessage
                    </MudText>
                }

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="_form is null "
                           OnClick="PerformLogin"
                           Class="mt-6"
                           FullWidth="true">
                    Login
                </MudButton>
            </MudForm>

        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private MudForm? _form;
    private bool _isValid;

    private string _employeeCode = string.Empty;
    private string _password = string.Empty;
    private string _errorMessage = string.Empty;

    private bool _showPassword;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInputType = _showPassword ? InputType.Text : InputType.Password;
        _passwordIcon = _showPassword
            ? Icons.Material.Filled.Visibility
            : Icons.Material.Filled.VisibilityOff;
    }

    private async Task PerformLogin()
    {
        if (_form is null)
            return;

        await _form.Validate();
        if (!_isValid)
            return;

        _errorMessage = string.Empty;

        var result = await AuthService.LoginAsync(
            _employeeCode.Trim(),
            _password
        );

        if (!result.Success || result.EmployeeId == null)
        {
            _errorMessage = result.ErrorMessage ?? "Login fehlgeschlagen";
            return;
        }

        // ‚úÖ ZENTRALER LOGIN-STATE
      // Employee inkl. Rolle laden
var employee = await EmployeeService.GetEmployeeByIdAsync(
    result.EmployeeId.Value
);

if (employee == null)
{
    _errorMessage = "Mitarbeiter nicht gefunden";
    return;
}

// üîê Session inkl. Rolle setzen
await EmployeeSession.SignInAsync(
    employee.Id,
    employee.EmployeeCode,
    employee.Role
);


        // üîí Pflicht zur Passwort√§nderung
        if (result.MustChangePassword)
        {
            Navigation.NavigateTo(
                $"/employee/change-password/{result.EmployeeId.Value}"
            );
            return;
        }

        // ‚úÖ EINZIGER Redirect nach Login
        Navigation.NavigateTo("/employee/home");
    }
}
