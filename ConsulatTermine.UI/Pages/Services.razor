@page "/services"

@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.Domain.Entities
@using Blazored.SessionStorage

@inject IServiceService ServiceService
@inject ISessionStorageService Session
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Medium" Class="mx-auto mt-8">

    <!-- STEPPER -->
    <MudStepper Elevation="0" ActiveStep="0" Class="mb-6">
        <MudStep Label="Services" Completed="true" />
        <MudStep Label="Termine" />
        <MudStep Label="Formular" />
        <MudStep Label="Bestätigung" />
    </MudStepper>

    <MudCard Class="pa-6" Style="border-radius:12px">

        <!-- HEADER -->
        <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary">
            Termin buchen
        </MudText>

        <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-6">
            Für wie viele Personen möchten Sie einen Termin buchen?
        </MudText>

        <!-- PERSON COUNTER -->
        <MudStack Row JustifyContent="Center" AlignItems="AlignItems.Center" Spacing="2" Class="mb-6">
            <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Success" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="@(_personCount == 1)"
                       OnClick="DecrementPerson">
                <MudIcon Icon="@Icons.Material.Filled.Remove" />
            </MudButton>

            <MudText Typo="Typo.h6">@_personCount</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="@(_personCount == MaxPersons)"
                       OnClick="IncrementPerson">
                <MudIcon Icon="@Icons.Material.Filled.Add" />
            </MudButton>
        </MudStack>

        <MudDivider Class="mb-4" />

        <!-- SERVICES -->
        <MudText Typo="Typo.subtitle1" Class="mb-2">
            Für welche Services möchten Sie Termine buchen?
        </MudText>

        @if (_loading)
        {
            <MudProgressCircular Indeterminate />
        }
        else
        {
            @foreach (var s in _services)
            {
                <MudCard Class="mb-3" Style="background:#f9f9f9">
                    <MudCardContent>

                        <MudStack Row JustifyContent="SpaceBetween" AlignItems="AlignItems.Center">

                            <!-- INFO -->
                            <MudStack Class="flex-grow-1">
                                <MudText Typo="Typo.h6">@s.Name</MudText>

                                @if (!string.IsNullOrWhiteSpace(s.Description))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @s.Description
                                    </MudText>
                                }

                                <MudText Typo="Typo.caption">
                                    Slotdauer: @s.SlotDurationMinutes Min ·
                                    Kapazität: @(s.CapacityPerSlot > 0 ? s.CapacityPerSlot : 0)
                                </MudText>
                            </MudStack>

                            <!-- COUNTER -->
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                               Color="Color.Error"
                                               Disabled="@(GetAssignedCount(s.Id) == 0)"
                                               OnClick="@(() => DecrementService(s.Id))" />

                                <MudText Typo="Typo.subtitle1">
                                    @GetAssignedCount(s.Id)
                                </MudText>

                                <MudIconButton Icon="@Icons.Material.Filled.Add"
                                               Color="Color.Success"
                                               Disabled="@(TotalAssigned >= _personCount)"
                                               OnClick="@(() => IncrementService(s.Id))" />
                            </MudStack>

                        </MudStack>

                    </MudCardContent>
                </MudCard>
            }
        }

        <MudDivider Class="mt-4" />

        <!-- FOOTER -->
        <MudStack Row JustifyContent="FlexEnd" Spacing="2" Class="mt-4">

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Success"
                       OnClick="ResetAll">
                Zurücksetzen
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="!CanConfirm"
                       OnClick="ConfirmSelection">
                Bestätigen
            </MudButton>

        </MudStack>

    </MudCard>
</MudContainer>

@code {

    private int _personCount = 1;
    private const int MaxPersons = 5;

    private bool _loading = true;
    private List<Service> _services = new();

    // ServiceId -> Personenanzahl
    private Dictionary<int, int> _serviceAssignments = new();

    private int TotalAssigned => _serviceAssignments.Values.Sum();

    private bool CanConfirm =>
        _personCount > 0 &&
        TotalAssigned == _personCount &&
        _serviceAssignments.Values.All(v => v > 0);

    protected override async Task OnInitializedAsync()
    {
        _services = await ServiceService.GetAllServicesAsync();
        _loading = false;
    }

    private int GetAssignedCount(int serviceId)
        => _serviceAssignments.TryGetValue(serviceId, out var v) ? v : 0;

    private void IncrementPerson()
    {
        if (_personCount < MaxPersons)
        {
            _personCount++;
            NormalizeAssignments();
        }
    }

    private void DecrementPerson()
    {
        if (_personCount > 1)
        {
            _personCount--;
            NormalizeAssignments();
        }
    }

    private void IncrementService(int serviceId)
    {
        if (TotalAssigned >= _personCount)
            return;

        if (!_serviceAssignments.ContainsKey(serviceId))
            _serviceAssignments[serviceId] = 0;

        _serviceAssignments[serviceId]++;
    }

    private void DecrementService(int serviceId)
    {
        if (!_serviceAssignments.ContainsKey(serviceId))
            return;

        _serviceAssignments[serviceId]--;

        if (_serviceAssignments[serviceId] <= 0)
            _serviceAssignments.Remove(serviceId);
    }

    private void NormalizeAssignments()
    {
        while (TotalAssigned > _personCount)
        {
            var key = _serviceAssignments
                .OrderByDescending(x => x.Value)
                .First().Key;

            _serviceAssignments[key]--;

            if (_serviceAssignments[key] <= 0)
                _serviceAssignments.Remove(key);
        }
    }

    private async Task ConfirmSelection()
    {
        if (!CanConfirm)
            return;

        await Session.SetItemAsync("personCount", _personCount);
        await Session.SetItemAsync("serviceAssignments", _serviceAssignments);

        Navigation.NavigateTo("/appointment");
    }

    private void ResetAll()
    {
        _personCount = 1;
        _serviceAssignments.Clear();
    }
}
