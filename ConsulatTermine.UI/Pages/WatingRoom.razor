@page "/tv/waiting-room"
@implements IDisposable

@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Domain.Enums
@using ConsulatTermine.Application.Interfaces
@using MudBlazor

@inject IAppointmentService AppointmentService
@inject IWaitingRoomNotifier WaitingRoomNotifier
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.False"
              Class="pa-6 waiting-room-root">

    <!-- HEADER -->
    <MudPaper Class="pa-4 mb-6">
        <MudText Typo="Typo.h4">
            Wartezimmer â€“ Aufruf
        </MudText>

        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
            Stand: @_lastUpdated.ToString("HH:mm:ss")
        </MudText>

        @if (!_soundEnabled)
        {
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       Class="mt-3"
                       OnClick="EnableSoundAsync">
                ðŸ”Š Sound aktivieren
            </MudButton>
        }
    </MudPaper>

    <!-- CARDS -->
    <MudGrid Spacing="4">
        @foreach (var call in _activeCalls)
        {
            <MudItem xs="12" md="6" lg="4">
                <MudPaper Elevation="6"
                          Class="pa-5  tv-card"
                          data-appointment-id="@call.Id">

                    <!-- HEADER -->
                    <div class="tv-card-header">
                        <MudText Typo="Typo.h4" Class="tv-name">
                            @call.FullName
                        </MudText>

                        <MudChip T="String" Color="Color.Primary"
                                 Variant="Variant.Filled"
                                 Class="tv-service-chip">
                            @call.Service?.Name
                        </MudChip>
                    </div>

                    <MudDivider Class="my-4" />

                    <!-- INFO GRID -->
                    @if (WaitingRoomNotifier.TryGetWorkplace(
                        call.Id,
                        out var office,
                        out var room))
                    {
                        <MudGrid Justify="Justify.SpaceAround"
                                 AlignItems="AlignItems.Center">

                            <MudItem xs="4" Class="tv-info-item">
                                <div class="tv-ball">@office</div>
                                <div class="tv-label">BÃ¼ro</div>
                            </MudItem>

                            <MudItem xs="4" Class="tv-info-item">
                                <div class="tv-ball">@room</div>
                                <div class="tv-label">Zimmer</div>
                            </MudItem>

                            <MudItem xs="4" Class="tv-info-item">
                                <div class="tv-ball">
                                    @call.Service?.Floor
                                </div>
                                <div class="tv-label">Etage</div>
                            </MudItem>

                        </MudGrid>
                    }

                    <MudDivider Class="my-4" />

                    <!-- STATUS -->
                    <div class="tv-status">
                        <MudChip T="String" Color="Color.Warning"
                                 Variant="Variant.Filled"
                                 Size="Size.Large">
                            Bitte zum BÃ¼ro gehen
                        </MudChip>
                    </div>

                </MudPaper>
            </MudItem>
        }
    </MudGrid>

</MudContainer>

@code {
    private List<Appointment> _activeCalls = new();
    private DateTime _lastUpdated;

    private bool _soundEnabled;
    private bool _pendingSound;
    private int? _animateAppointmentId;

    protected override async Task OnInitializedAsync()
    {
        WaitingRoomNotifier.OnChanged += HandleChanged;
        await LoadAsync();
    }

    private void HandleChanged(
        WaitingRoomChangeReason reason,
        int? appointmentId)
    {
        _ = InvokeAsync(async () =>
        {
            await LoadAsync();

            if (_soundEnabled &&
                (reason == WaitingRoomChangeReason.Call ||
                 reason == WaitingRoomChangeReason.Recall))
            {
                _pendingSound = true;
                _animateAppointmentId = appointmentId;
            }

            StateHasChanged();
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_pendingSound)
        {
            _pendingSound = false;
            await JS.InvokeVoidAsync(
                "onWaitingRoomUpdated",
                _animateAppointmentId);
        }
    }

    private async Task EnableSoundAsync()
    {
        _soundEnabled =
            await JS.InvokeAsync<bool>("SoundService.unlock");
        StateHasChanged();
    }

    private async Task LoadAsync()
    {
        _activeCalls = (await AppointmentService
                .GetActiveWaitingRoomAppointmentsAsync())
            .Where(a => a.Status == AppointmentStatus.InProgress)
            .OrderBy(a => a.Date)
            .ToList();

        _lastUpdated = DateTime.Now;
    }

    public void Dispose()
    {
        WaitingRoomNotifier.OnChanged -= HandleChanged;
    }
}
