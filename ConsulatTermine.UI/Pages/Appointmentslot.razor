@page "/appointment"

@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Domain.Entities
@using Blazored.SessionStorage

@inject ISessionStorageService Session
@inject IAppointmentService AppointmentService
@inject IServiceService ServiceService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">

    <!-- STEP 2 -->
    <MudStepper Linear="true" DisableNavigation="true" @bind-ActiveIndex="_activeStep" Class="mb-6">
        <MudStep Title="1. Service" Completed="true" />
        <MudStep Title="2. Termin wählen" />
        <MudStep Title="3. Ihre Daten" />
    </MudStepper>

    <MudPaper Class="pa-4">

        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
            <MudText>Lade verfügbare Termine...</MudText>
        }
        else
        {
            <!-- Header -->
            <h3 class="title">@_service?.Name</h3>
            <MudText Typo="Typo.body2" Class="mb-3">
                Sie können bis zu @_personCount Platz/Plätze auswählen.
            </MudText>

            <div class="appointment-layout">

                <!-- KALENDER LINKS -->
                <div class="calendar-container">
                    <MudDatePicker Date="_selectedDate"
                                   DateChanged="OnDateChanged"
                                   PickerVariant="PickerVariant.Static"
                                   Color="Color.Primary"
                                   Class="calendar-ui" />
                </div>

                <!-- SLOTS RECHTS -->
                <div class="slots-container">
                    <h4 class="slot-title">@_selectedDate.ToLongDateString()</h4>

                    @if (_availableSlots.Count == 0)
                    {
                        <MudText Typo="Typo.body1">Keine Termine verfügbar.</MudText>
                    }
                    else
                    {
                        @foreach (var slot in _availableSlots)
                        {
                            <div class="slot-card @(IsSlotSelected(slot) ? "slot-selected" : "")"
                                 @onclick="() => ToggleSlot(slot)">
                                
                                <div class="slot-left">
                                    <div class="slot-time">
                                        @slot.SlotStart.ToString(@"hh\:mm")
                                    </div>
                                    <div class="slot-capacity">
                                        @slot.FreeCapacity Platz/Plätze frei
                                    </div>
                                </div>

                                @if (_personCount > 1 && IsSlotSelected(slot))
                                {
                                    <div class="slot-right">

                                        <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                       Disabled="@(GetSlotAssigned(slot) <= 0)"
                                                       OnClick="@(() => DecrementSlot(slot))"
                                                       Class="counter-btn" />

                                        <span class="counter">@GetSlotAssigned(slot)</span>

                                        <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                       Disabled="@(GetSlotAssigned(slot) >= slot.FreeCapacity || TotalAssigned >= _personCount)"
                                                       OnClick="@(() => IncrementSlot(slot))"
                                                       Class="counter-btn" />

                                    </div>
                                }

                            </div>
                        }
                    }

                    <MudButton Variant="Variant.Filled"
                               Disabled="!CanConfirm"
                               Class="confirm-btn"
                               OnClick="ConfirmSelection">
                        Kalender bestätigen
                    </MudButton>
                </div>

            </div>

        }
    </MudPaper>

</MudContainer>

@code {

    private int _activeStep = 1;

    private int _personCount = 1;
    private int _serviceId;

    private Service? _service;

    private bool _loading = true;

    private DateTime _selectedDate = DateTime.Today;
    private List<AvailableSlotDto> _availableSlots = new();

    private Dictionary<TimeSpan, int> _slotAssignments = new();

    private int TotalAssigned => _slotAssignments.Values.Sum();
    private bool CanConfirm => _personCount == 1
                            ? _slotAssignments.Count == 1
                            : TotalAssigned == _personCount;

    protected override async Task OnInitializedAsync()
    {
        _personCount = await Session.GetItemAsync<int>("personCount");
        _serviceId = await Session.GetItemAsync<int>("selectedServiceId");

        _service = await ServiceService.GetServiceByIdAsync(_serviceId);

        _selectedDate = DateTime.Today;

        await LoadSlots();

        _loading = false;
    }

    private async Task OnDateChanged(DateTime? date)
    {
        if (date == null) return;

        _selectedDate = date.Value;
        await LoadSlots();
    }

    private async Task LoadSlots()
    {
        _availableSlots = await AppointmentService.GetAvailableSlotDtosAsync(_serviceId, _selectedDate);

        if (_personCount == 1)
            _slotAssignments.Clear();
    }

    private bool IsSlotSelected(AvailableSlotDto slot)
        => _slotAssignments.ContainsKey(slot.SlotStart.TimeOfDay);

    private int GetSlotAssigned(AvailableSlotDto slot)
        => _slotAssignments.TryGetValue(slot.SlotStart.TimeOfDay, out var v) ? v : 0;

    private void ToggleSlot(AvailableSlotDto slot)
    {
        if (_personCount == 1)
        {
            _slotAssignments.Clear();
            _slotAssignments[slot.SlotStart.TimeOfDay] = 1;
        }
        else
        {
            if (!_slotAssignments.ContainsKey(slot.SlotStart.TimeOfDay))
                _slotAssignments[slot.SlotStart.TimeOfDay] = 0;
        }
    }

    private void IncrementSlot(AvailableSlotDto slot)
    {
        var assigned = GetSlotAssigned(slot);

        if (assigned < slot.FreeCapacity && TotalAssigned < _personCount)
            _slotAssignments[slot.SlotStart.TimeOfDay] = assigned + 1;
    }

    private void DecrementSlot(AvailableSlotDto slot)
    {
        var assigned = GetSlotAssigned(slot);

        if (assigned <= 0) return;

        if (assigned == 1)
            _slotAssignments.Remove(slot.SlotStart.TimeOfDay);
        else
            _slotAssignments[slot.SlotStart.TimeOfDay] = assigned - 1;
    }

    private async Task ConfirmSelection()
    {
        await Session.SetItemAsync("selectedSlots", _slotAssignments);
        await Session.SetItemAsync("selectedDate", _selectedDate);

        Navigation.NavigateTo("/appointment-form");
    }
}
