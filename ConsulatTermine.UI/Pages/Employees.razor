@page "/admin/employees"

@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Domain.Entities

@inject IEmployeeService EmployeeService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <MudStack Spacing="2">

        <MudText Typo="Typo.h5">Mitarbeiter</MudText>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="NewEmployee">
            Neuer Mitarbeiter
        </MudButton>

        <MudTable Items="_employees" Hover Dense>

            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Aktionen</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.Id</MudTd>
                <MudTd>@($"{context.FirstName} {context.LastName}")</MudTd>
                <MudTd>@context.Email</MudTd>

                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => EditEmployee(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"
                                   OnClick="@(() => DeleteEmployee(context))" />
                </MudTd>
            </RowTemplate>

        </MudTable>

        @if (_editOpen)
        {
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h6">
                    @(_editId == 0 ? "Neuer Mitarbeiter" : "Mitarbeiter bearbeiten")
                </MudText>

                <MudStack Spacing="2">

                    <MudTextField Label="Vorname" @bind-Value="_model.FirstName" Required />
                    <MudTextField Label="Nachname" @bind-Value="_model.LastName" Required />
                    <MudTextField Label="E-Mail" @bind-Value="_model.Email" Required />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveAsync">
                        Speichern
                    </MudButton>

                </MudStack>
            </MudPaper>
        }

    </MudStack>
</MudPaper>

@code {
    private List<Employee> _employees = new();
    private bool _editOpen;
    private int _editId;
    private EmployeeDto _model = new();

    protected override async Task OnInitializedAsync()
    {
        _employees = await EmployeeService.GetAllEmployeesAsync();
    }

    private void NewEmployee()
    {
        _model = new EmployeeDto();
        _editId = 0;
        _editOpen = true;
    }

    private void EditEmployee(Employee e)
    {
        _model = new EmployeeDto
        {
            FirstName = e.FirstName,
            LastName = e.LastName,
            Email = e.Email
        };

        _editId = e.Id;
        _editOpen = true;
    }

    private async Task SaveAsync()
    {
        if (_editId == 0)
            await EmployeeService.CreateEmployeeAsync(_model);
        else
            await EmployeeService.UpdateEmployeeAsync(_editId, _model);

        _employees = await EmployeeService.GetAllEmployeesAsync();
        _editOpen = false;
    }

    private async Task DeleteEmployee(Employee e)
    {
        await EmployeeService.DeleteEmployeeAsync(e.Id);
        _employees = await EmployeeService.GetAllEmployeesAsync();
    }
}
