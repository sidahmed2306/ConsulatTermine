@page "/admin/working-hours"

@using MudBlazor
@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Application.Interfaces
@using Microsoft.AspNetCore.Components.Forms

@inject IWorkingHoursService WorkingHoursService
@inject IServiceService ServiceService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">

    <MudStack Spacing="2">

        <!-- Header -->
        <MudStack Direction="Row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h5">Arbeitszeiten</MudText>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@NewEntry">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="me-2" />
                Neue Arbeitszeit
            </MudButton>
        </MudStack>

        <!-- Akkordeon: pro Service ein Panel -->
        @if (_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="mt-4">
                <MudProgressCircular Indeterminate="true" />
            </MudStack>
        }
        else if (!_items.Any())
        {
            <MudText Class="mt-2">Noch keine Arbeitszeiten erfasst.</MudText>
        }
        else
        {
            <MudExpansionPanels Class="mt-2">
                @foreach (var group in GroupedByService)
                {
                    var service = _services.FirstOrDefault(s => s.Id == group.Key);
                    var serviceName = service?.Name ?? $"Service #{group.Key}";

                    <MudExpansionPanel Text="@serviceName">
                        <MudTable Items="group.OrderBy(g => g.Day)" Dense="true">

                            <HeaderContent>
                                <MudTh>Tag</MudTh>
                                <MudTh>Start</MudTh>
                                <MudTh>Ende</MudTh>
                                <MudTh style="width:150px;">Aktionen</MudTh>
                            </HeaderContent>

                            <RowTemplate>
                                <MudTd>@context.Day</MudTd>
                                <MudTd>@context.StartTime.ToString(@"hh\:mm")</MudTd>
                                <MudTd>@context.EndTime.ToString(@"hh\:mm")</MudTd>

                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   OnClick="@(() => EditEntry(context))" />

                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   OnClick="@(() => DeleteEntry(context))" />
                                </MudTd>
                            </RowTemplate>

                            <NoRecordsContent>
                                <MudText>Keine Tage für diesen Service.</MudText>
                            </NoRecordsContent>

                        </MudTable>
                    </MudExpansionPanel>
                }
            </MudExpansionPanels>
        }

        <!-- Formular (unterhalb, wie bei deinen anderen Admin-Seiten) -->
        @if (_formOpen)
        {
            <MudPaper Class="pa-4 mt-4">

                <MudText Typo="Typo.h6">
                    @(_editId == 0 ? "Neue Arbeitszeit-Regel erstellen" : "Arbeitszeit bearbeiten")
                </MudText>

                <EditForm Model="_form" OnValidSubmit="Save" OnInvalidSubmit="OnInvalid">

                    <DataAnnotationsValidator />

                    <MudStack Spacing="2" Class="mt-3">

                        <!-- Service -->
                        <MudSelect T="int"
                                   Label="Service"
                                   @bind-Value="_form.ServiceId"
                                   Required="true">
                            @foreach (var s in _services)
                            {
                                <MudSelectItem Value="@s.Id">@s.Name</MudSelectItem>
                            }
                        </MudSelect>

                        <!-- Wochentage: bei Neu MultiSelect, bei Edit nur Anzeige eines Tages -->
                        @if (_editId == 0)
                        {
                            <!-- Mehrere Tage auf einmal anlegen -->
                           <MudSelect T="DayOfWeek"
                              Label="Wochentage"
                              MultiSelection="true"
                              SelectedValues="@_form.SelectedDays"
                              SelectedValuesChanged="OnDaysChanged"
                              Required="true">

                             @foreach (DayOfWeek d in Enum.GetValues(typeof(DayOfWeek)))
                             {
                               <MudSelectItem Value="@d">@d</MudSelectItem>
                             }
                            </MudSelect>

                        }
                        else
                        {
                            <!-- Beim Bearbeiten nur ein Tag (kein MultiSelect) -->
                            <MudSelect T="DayOfWeek"
                                       Label="Wochentag"
                                       @bind-Value="_form.Day"
                                       Disabled="true">
                                @foreach (DayOfWeek d in Enum.GetValues(typeof(DayOfWeek)))
                                {
                                    <MudSelectItem Value="@d">@d</MudSelectItem>
                                }
                            </MudSelect>
                        }

                        <!-- Zeiten -->
                        <MudTimePicker Label="Startzeit"
                                       AmPm="false"
                                       @bind-Time="_form.StartTime"/>

                        <MudTimePicker Label="Endzeit"
                                       AmPm="false"
                                       @bind-Time="_form.EndTime" />

                        @if (!string.IsNullOrEmpty(_error))
                        {
                            <MudAlert Severity="Severity.Error">@_error</MudAlert>
                        }

                        <MudStack Direction="Row" Spacing="2" Justify="Justify.FlexEnd">
                            <MudButton Variant="Variant.Text" OnClick="@Cancel">
                                Abbrechen
                            </MudButton>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       ButtonType="ButtonType.Submit">
                                Speichern
                            </MudButton>
                        </MudStack>

                    </MudStack>

                </EditForm>

            </MudPaper>
        }

    </MudStack>

</MudPaper>

@code {

    // ----------------- Anzeige-Daten -----------------

    private List<WorkingHours> _items = new();
    private List<Service> _services = new();

    private bool _loading = true;
    private bool _formOpen = false;
    private int _editId = 0;
    private string? _error;

    // Akkordeon: Gruppierung nach Service
    private IEnumerable<IGrouping<int, WorkingHours>> GroupedByService
        => _items.GroupBy(w => w.ServiceId);


    // ----------------- Formular-Model -----------------

    private class WorkingHoursFormModel
    {
        public int ServiceId { get; set; }

        // für "Neu": mehrere Tage
        public HashSet<DayOfWeek> SelectedDays { get; set; } = new();

        // für "Edit": einzelner Tag
        public DayOfWeek Day { get; set; } = DayOfWeek.Monday;

        public TimeSpan? StartTime { get; set; } = new TimeSpan(8, 0, 0);
        public TimeSpan? EndTime { get; set; } = new TimeSpan(16, 0, 0);
    }

    private WorkingHoursFormModel _form = new();


    // ----------------- Lifecycle -----------------

    protected override async Task OnInitializedAsync()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;

        _services = await ServiceService.GetAllServicesAsync();
        await LoadItems();
    }

    private async Task LoadItems()
    {
        _loading = true;
        _items = await WorkingHoursService.GetAllAsync();
        _loading = false;
    }


    // ----------------- Aktionen: NEU / EDIT / DELETE -----------------

    private void NewEntry()
    {
        _form = new WorkingHoursFormModel
        {
            ServiceId = _services.FirstOrDefault()?.Id ?? 0,
            Day = DayOfWeek.Monday,
            StartTime = new TimeSpan(8, 0, 0),
            EndTime = new TimeSpan(16, 0, 0)
        };

        _form.SelectedDays.Clear(); // MultiSelect leer

        _editId = 0;
        _error = null;
        _formOpen = true;
    }

    private void EditEntry(WorkingHours w)
    {
        _form = new WorkingHoursFormModel
        {
            ServiceId = w.ServiceId,
            Day = w.Day,
            StartTime = w.StartTime,
            EndTime = w.EndTime
        };

        _form.SelectedDays.Clear();
        _form.SelectedDays.Add(w.Day); // nur zur Info, wird aber bei Edit nicht genutzt

        _editId = w.Id;
        _error = null;
        _formOpen = true;
    }

    private void Cancel()
    {
        _formOpen = false;
        _error = null;
    }

   private void OnInvalid(EditContext context)
{
    _error = "Bitte alle Pflichtfelder korrekt ausfüllen.";
    Snackbar.Add(_error, Severity.Error);
}


    private async Task Save()
    {
        if (_form.StartTime == null || _form.EndTime == null || _form.StartTime >= _form.EndTime)
        {
            _error = "Startzeit muss vor Endzeit liegen.";
            Snackbar.Add(_error, Severity.Error);
            return;
        }

        try
        {
            if (_editId == 0)
            {
                // NEUE REGEL: für alle ausgewählten Tage einzelne WorkingHours anlegen
                if (_form.SelectedDays == null || !_form.SelectedDays.Any())
                {
                    _error = "Bitte mindestens einen Wochentag auswählen.";
                    Snackbar.Add(_error, Severity.Error);
                    return;
                }

                foreach (var day in _form.SelectedDays)
                {
                    var entity = new WorkingHours
                    {
                        ServiceId = _form.ServiceId,
                        Day = day,
                        StartTime = _form.StartTime ?? new TimeSpan(8, 0, 0),
                        EndTime = _form.EndTime ?? new TimeSpan(16, 0, 0)
                    };

                    await WorkingHoursService.CreateAsync(entity);
                }

                Snackbar.Add("Arbeitszeiten erstellt!", Severity.Success);
            }
            else
            {
                // BEARBEITEN: nur einen bestehenden Eintrag aktualisieren
                var entity = new WorkingHours
                {
                    Id = _editId,
                    ServiceId = _form.ServiceId,
                    Day = _form.Day,
                    StartTime = _form.StartTime ?? new TimeSpan(8, 0, 0),
                    EndTime = _form.EndTime ?? new TimeSpan(16, 0, 0)
                };

                await WorkingHoursService.UpdateAsync(_editId, entity);
                Snackbar.Add("Arbeitszeit aktualisiert!", Severity.Success);
            }

            _formOpen = false;
            await LoadItems();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }


    private async Task DeleteEntry(WorkingHours w)
    {
        var ok = await WorkingHoursService.DeleteAsync(w.Id);

        if (!ok)
        {
            Snackbar.Add("Löschen fehlgeschlagen.", Severity.Error);
            return;
        }

        Snackbar.Add("Arbeitszeit gelöscht!", Severity.Success);
        await LoadItems();
    }

    private void OnDaysChanged(HashSet<DayOfWeek> values)
    {
       _form.SelectedDays = values;
    }

}
