@page "/admin/working-schedule"

@using System.Linq
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Application.DTOs.WorkingSchedulePlan
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.Application.ViewModels
@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Domain.Enums
@using ConsulatTermine.UI.Authentication
@using MudBlazor


@inject EmployeeSessionService EmployeeSession
@inject NavigationManager Navigation

@inject IServiceService ServiceService
@inject IWorkingScheduleService WorkingScheduleService
@inject IWorkingScheduleOverviewService OverviewService
@inject IWorkingSchedulePlanService WorkingSchedulePlanService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">

    <MudText Typo="Typo.h5" Class="mb-2">Dienstplan & Öffnungszeiten – Jahrespläne pro Service</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        Hier legst du reguläre Öffnungszeiten fest und definierst wöchentliche / datumspezifische Ausnahmen.
        Die Kapazität pro Slot wird als Basis aus dem Service angezeigt (und kann optional pro Ausnahme überschrieben werden).
    </MudText>

    <MudExpansionPanels Multiple="false" Elevation="0">

        <!-- STEP 1 -->
        <MudExpansionPanel Text="1. Service auswählen" Expanded="@(_activeStep == 0)">
            <MudStack Class="pa-4" Spacing="2">

                <MudSelect T="int"
                           Label="Service"
                           Value="_model.ServiceId"
                           ValueChanged="@(async (int value) => await OnServiceChanged(value))"
                           ValueExpression="@(() => _model.ServiceId)"
                           Required="true"
                           FullWidth="true">
                    @foreach (var s in _services)
                    {
                        <MudSelectItem Value="@s.Id">@s.Name</MudSelectItem>
                    }
                </MudSelect>

                @if (_model.ServiceId > 0)
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Basis-Kapazität pro Slot: <b>@(GetBaseCapacity()?.ToString() ?? "0")</b> |
                        Mitarbeiter zugewiesen: <b>@GetEmployeeCount()</b> |
                        Slotdauer: <b>@GetSlotDuration()</b> Min
                    </MudAlert>

                    
                }

                <MudStack Direction="Row" Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@(!IsStep1Valid)"
                               OnClick="@(() => GoToStep(1))">
                        Weiter
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudExpansionPanel>

        <!-- STEP 2 -->
        <MudExpansionPanel Text="2. Jahr auswählen" Expanded="@(_activeStep == 1)" Disabled="@(!IsStep1Valid)">
            <MudStack Class="pa-4" Spacing="2">

                <MudSelect T="int"
                           Label="Jahr"
                           @bind-Value="_model.Year"
                           Required="true"
                           FullWidth="true">
                    @foreach (var y in _years)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>

                <MudStack Direction="Row" Justify="Justify.SpaceBetween">
                    <MudButton Variant="Variant.Text" OnClick="@(() => GoToStep(0))">Zurück</MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@(!IsStep2Valid)"
                               OnClick="@(() => GoToStep(2))">
                        Weiter
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudExpansionPanel>

        <!-- STEP 3 -->
        <MudExpansionPanel Text="3. Monate auswählen" Expanded="@(_activeStep == 2)" Disabled="@(!IsStep2Valid)">
            <MudStack Class="pa-4" Spacing="2">

                <MudText Typo="Typo.subtitle2">Bitte Monate auswählen</MudText>

                <MudSelect T="int"
                           MultiSelection="true"
                           Label="Monate"
                           Required="true"
                           FullWidth="true"
                           SelectedValues="_selectedMonths"
                           SelectedValuesChanged="@( (IEnumerable<int> values) => OnMonthsChanged(values) )">
                    @foreach (var kvp in _monthNames)
                    {
                        <MudSelectItem Value="@kvp.Key">@kvp.Value</MudSelectItem>
                    }
                </MudSelect>

                @if (IsStep2Valid && _selectedMonths.Any())
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Geplanter Zeitraum (aus Min/Max): <b>@GetPlannedRangeText()</b>
                    </MudAlert>
                }

                <MudStack Direction="Row" Justify="Justify.SpaceBetween">
                    <MudButton Variant="Variant.Text" OnClick="@(() => GoToStep(1))">Zurück</MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@(!IsStep3Valid)"
                               OnClick="@(() => GoToStep(3))">
                        Weiter
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudExpansionPanel>

        <!-- STEP 4 -->
        <MudExpansionPanel Text="4. Reguläre Öffnungstage & Zeiten" Expanded="@(_activeStep == 3)" Disabled="@(!IsStep3Valid)">
            <MudStack Class="pa-4" Spacing="2">

                <MudText Typo="Typo.subtitle2">Reguläre Öffnungstage</MudText>

                <MudGrid>
                    @foreach (var d in _orderedDays)
                    {
                        <MudItem xs="6" sm="4" md="3">
                            <MudCheckBox T="bool"
                                         Label="@d.ToString()"
                                         UncheckedColor="Color.Default"
                                         Color="Color.Success"
                                         Value="_model.RegularDays.Contains(d)"
                                         ValueChanged="@((bool v) => OnRegularDayChanged(d, v))" />
                        </MudItem>
                    }
                </MudGrid>

                <MudDivider Class="my-2" />

                <MudText Typo="Typo.subtitle2">Reguläre Öffnungszeiten</MudText>
                <MudStack Direction="Row" Spacing="2" AlignItems="AlignItems.Center">
                    <MudTimePicker Label="Startzeit" @bind-Time="_model.StartTime" AmPm="false" />
                    <MudTimePicker Label="Endzeit" @bind-Time="_model.EndTime" AmPm="false" />
                </MudStack>

                <MudStack Direction="Row" Justify="Justify.SpaceBetween">
                    <MudButton Variant="Variant.Text" OnClick="@(() => GoToStep(2))">Zurück</MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@(!IsStep4Valid)"
                               OnClick="@(() => GoToStep(4))">
                        Weiter
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudExpansionPanel>

        <!-- STEP 5 -->
        <MudExpansionPanel Text="5. Ausnahmen (wöchentlich & Datum)" Expanded="@(_activeStep == 4)" Disabled="@(!IsStep4Valid)">
            <MudStack Class="pa-4" Spacing="3">

                <!-- WEEKLY -->
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h6">Wöchentliche Ausnahmen</MudText>

                    <MudTable Items="_model.WeeklyOverrides" Dense="true" Hover="true" Class="mb-2">
                        <HeaderContent>
                            <MudTh>Tag</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Start</MudTh>
                            <MudTh>Ende</MudTh>
                            <MudTh>Kapazität</MudTh>
                            <MudTh>Aktion</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Day</MudTd>
                            <MudTd>@(context.IsClosed ? "Geschlossen" : "Geändert")</MudTd>
                            <MudTd>@(context.StartTime?.ToString(@"hh\:mm") ?? "-")</MudTd>
                            <MudTd>@(context.EndTime?.ToString(@"hh\:mm") ?? "-")</MudTd>
                            <MudTd>@(context.CapacityPerSlotOverride?.ToString() ?? "(Basis)")</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Primary"
                                               OnClick="@(() => BeginEditWeekly(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveWeeklyOverride(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    <MudPaper Class="pa-3">
                        <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">
                                @(_isEditingWeekly ? "Wöchentliche Ausnahme bearbeiten" : "Neue wöchentliche Ausnahme")
                            </MudText>

                            @if (_isEditingWeekly)
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@CancelEditWeekly">
                                    Abbrechen
                                </MudButton>
                            }
                        </MudStack>

                        @if (_model.ServiceId > 0)
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                                Basis-Kapazität pro Slot für diesen Service: <b>@(GetBaseCapacity()?.ToString() ?? "0")</b>
                            </MudAlert>
                        }

                        <MudStack Spacing="2">

                            <MudSelect T="DayOfWeek"
                                       Label="Wochentag"
                                       @bind-Value="_newWeekly.Day"
                                       Disabled="@_isEditingWeekly"
                                       FullWidth="true">
                                @foreach (var d in _orderedDays)
                                {
                                    <MudSelectItem Value="@d">@d.ToString()</MudSelectItem>
                                }
                            </MudSelect>

                            <MudCheckBox T="bool"
                                         Value="_newWeekly.IsClosed"
                                         ValueChanged="OnWeeklyClosedChanged"
                                         ValueExpression="@(() => _newWeekly.IsClosed)"
                                         Label="Geschlossen" />

                            @if (!_newWeekly.IsClosed)
                            {
                                <MudTimePicker Label="Startzeit" @bind-Time="_newWeekly.StartTime" AmPm="false" />
                                <MudTimePicker Label="Endzeit" @bind-Time="_newWeekly.EndTime" AmPm="false" />

                                <MudNumericField T="int?"
                                                 Label="Kapazität pro Slot (optional)"
                                                 HelperText="Leer lassen = Basis-Kapazität verwenden"
                                                 @bind-Value="_newWeekly.CapacityPerSlotOverride" />
                            }

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(!CanSubmitWeekly)"
                                       OnClick="@SubmitWeekly">
                                @(_isEditingWeekly ? "Aktualisieren" : "Hinzufügen")
                            </MudButton>

                        </MudStack>
                    </MudPaper>
                </MudStack>

                <MudDivider />

                <!-- DATE -->
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h6">Datumspezifische Ausnahmen</MudText>

                    <MudTable Items="_model.DateOverrides" Dense="true" Hover="true" Class="mb-2">
                        <HeaderContent>
                            <MudTh>Datum</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Start</MudTh>
                            <MudTh>Ende</MudTh>
                            <MudTh>Kapazität</MudTh>
                            <MudTh>Aktion</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@(context.Date?.ToString("dd.MM.yyyy") ?? "-")</MudTd>
                            <MudTd>@(context.IsClosed ? "Geschlossen" : "Geändert")</MudTd>
                            <MudTd>@(context.StartTime?.ToString(@"hh\:mm") ?? "-")</MudTd>
                            <MudTd>@(context.EndTime?.ToString(@"hh\:mm") ?? "-")</MudTd>
                            <MudTd>@(context.CapacityPerSlotOverride?.ToString() ?? "(Basis)")</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Primary"
                                               OnClick="@(() => BeginEditDate(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               OnClick="@(() => RemoveDateOverride(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    <MudPaper Class="pa-3">
                        <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">
                                @(_isEditingDate ? "Datums-Ausnahme bearbeiten" : "Neue Datums-Ausnahme")
                            </MudText>

                            @if (_isEditingDate)
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@CancelEditDate">
                                    Abbrechen
                                </MudButton>
                            }
                        </MudStack>

                        @if (_model.ServiceId > 0)
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                                Basis-Kapazität pro Slot für diesen Service: <b>@(GetBaseCapacity()?.ToString() ?? "0")</b>
                            </MudAlert>
                        }

                        <MudStack Spacing="2">

                            <MudDatePicker Label="Datum" @bind-Date="_newDate.Date" Disabled="@_isEditingDate" />

                            <MudCheckBox T="bool"
                                         Value="_newDate.IsClosed"
                                         ValueChanged="OnDateClosedChanged"
                                         ValueExpression="@(() => _newDate.IsClosed)"
                                         Label="Geschlossen" />

                            @if (!_newDate.IsClosed)
                            {
                                <MudTimePicker Label="Startzeit" @bind-Time="_newDate.StartTime" AmPm="false" />
                                <MudTimePicker Label="Endzeit" @bind-Time="_newDate.EndTime" AmPm="false" />

                                <MudNumericField T="int?"
                                                 Label="Kapazität pro Slot (optional)"
                                                 HelperText="Leer lassen = Basis-Kapazität verwenden"
                                                 @bind-Value="_newDate.CapacityPerSlotOverride" />
                            }

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(!CanSubmitDate)"
                                       OnClick="@SubmitDate">
                                @(_isEditingDate ? "Aktualisieren" : "Hinzufügen")
                            </MudButton>

                        </MudStack>
                    </MudPaper>
                </MudStack>

                <MudStack Direction="Row" Justify="Justify.SpaceBetween">
                    <MudButton Variant="Variant.Text" OnClick="@(() => GoToStep(3))">Zurück</MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="@(() => GoToStep(5))">
                        Weiter
                    </MudButton>
                </MudStack>

            </MudStack>
        </MudExpansionPanel>

        <!-- STEP 6 -->
        <MudExpansionPanel Text="6. Speichern" Expanded="@(_activeStep == 5)" Disabled="@(!IsStep4Valid)">
            <MudStack Class="pa-4" Spacing="2">

                <MudText Typo="Typo.h6">Zusammenfassung</MudText>

                <MudPaper Class="pa-3">
                    <MudGrid>

                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2">Allgemein</MudText>
                            <MudList T="string" Dense="true">
                                <MudListItem T="string">
                                    <MudText><b>Service:</b> @GetSelectedService()?.Name</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText><b>Jahr:</b> @_model.Year</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText><b>Monate:</b> @FormatMonths(_model.Months)</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText><b>Zeitraum (Min/Max):</b> @GetPlannedRangeText()</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText><b>Basis-Kapazität:</b> @(GetBaseCapacity()?.ToString() ?? "0")</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText><b>Mitarbeiter:</b> @GetEmployeeCount()</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText><b>Slotdauer:</b> @GetSlotDuration() Min</MudText>
                                </MudListItem>
                            </MudList>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2">Regulär</MudText>
                            <MudList T="string" Dense="true">
                                <MudListItem T="string">
                                    <MudText>
                                        <b>Tage:</b> @FormatDays(_model.RegularDays)
                                    </MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText>
                                        <b>Zeiten:</b>
                                        @if (_model.StartTime.HasValue && _model.EndTime.HasValue)
                                        {
                                            @($"{_model.StartTime:hh\\:mm} - {_model.EndTime:hh\\:mm}")
                                        }
                                        else
                                        {
                                            @("-")
                                        }
                                    </MudText>
                                </MudListItem>
                            </MudList>
                        </MudItem>

                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2">Wöchentliche Ausnahmen</MudText>

                            @if (_model.WeeklyOverrides.Count == 0)
                            {
                                <MudText Typo="Typo.body2">-</MudText>
                            }
                            else
                            {
                                <MudList T="string" Dense="true">
                                    @foreach (var w in _model.WeeklyOverrides.OrderBy(x => x.Day))
                                    {
                                        <MudListItem T="string">
                                            <MudText>
                                                <b>@w.Day:</b>
                                                @(w.IsClosed
                                                    ? "Geschlossen"
                                                    : $"{w.StartTime:hh\\:mm} - {w.EndTime:hh\\:mm}")
                                                @(w.CapacityPerSlotOverride.HasValue ? $" | Kap: {w.CapacityPerSlotOverride}" : " | Kap: (Basis)")
                                            </MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2">Datumspezifische Ausnahmen</MudText>

                            @if (_model.DateOverrides.Count == 0)
                            {
                                <MudText Typo="Typo.body2">-</MudText>
                            }
                            else
                            {
                                <MudList T="string" Dense="true">
                                    @foreach (var d in _model.DateOverrides
                                        .Where(x => x.Date.HasValue)
                                        .OrderBy(x => x.Date!.Value))
                                    {
                                        <MudListItem T="string">
                                            <MudText>
                                                <b>@d.Date!.Value.ToString("dd.MM.yyyy"):</b>
                                                @(d.IsClosed
                                                    ? "Geschlossen"
                                                    : $"{d.StartTime:hh\\:mm} - {d.EndTime:hh\\:mm}")
                                                @(d.CapacityPerSlotOverride.HasValue ? $" | Kap: {d.CapacityPerSlotOverride}" : " | Kap: (Basis)")
                                            </MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                        </MudItem>

                    </MudGrid>
                </MudPaper>

                <MudAlert Severity="Severity.Info" Dense="true">
                    Beim Speichern werden WorkingSchedulePlan, WorkingHours und ServiceDayOverrides generiert.
                </MudAlert>

                <MudStack Direction="Row" Justify="Justify.SpaceBetween" Spacing="2">
                    <MudButton Variant="Variant.Text" OnClick="@(() => GoToStep(4))">Zurück</MudButton>

                    <MudStack Direction="Row" Spacing="2">
                        <MudButton Variant="Variant.Outlined" OnClick="@ResetForm">Zurücksetzen</MudButton>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   Disabled="@_saving"
                                   OnClick="@SaveAsync">
                            @if (_saving)
                            {
                                <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="me-2" />
                            }
                            Speichern
                        </MudButton>
                    </MudStack>
                </MudStack>

            </MudStack>
        </MudExpansionPanel>

    </MudExpansionPanels>

    <MudDivider Class="my-6" />

    <!-- Overview (dein bestehender Überblick bleibt, damit du weiterhin "Bearbeiten/Löschen" wie bisher nutzen kannst) -->
    <MudStack Spacing="2">
        <MudText Typo="Typo.h6">Aktuelle Dienstplan-Übersicht</MudText>

        @if (_overviewLoading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_overview.Count == 0)
        {
            <MudText>Keine Pläne vorhanden.</MudText>
        }
        else
        {
            <MudExpansionPanels Multiple="true" Elevation="0">
                @foreach (var item in _overview)
                {
                    <MudExpansionPanel Text="@($"{item.ServiceName} (Mitarbeiter: {item.EmployeeCount}, Basis-Kapazität: {item.DefaultCapacityPerSlot})")">

                        @if (item.YearPlans == null || item.YearPlans.Count == 0)
                        {
                            <MudText Class="pa-4">Noch keine Jahrespläne vorhanden.</MudText>
                        }
                        else
                        {
                            <MudTable Items="item.YearPlans" Dense="true" Hover="true" Class="ma-2">
                                <HeaderContent>
                                    <MudTh style="width:90px;">Jahr</MudTh>
                                    <MudTh>Monate</MudTh>
                                    <MudTh>Regulär</MudTh>
                                    <MudTh>Wöchentlich</MudTh>
                                    <MudTh>Datum</MudTh>
                                    <MudTh style="width:170px;">Aktionen</MudTh>
                                </HeaderContent>

                                <RowTemplate>
                                    <MudTd DataLabel="Jahr">@context.Year</MudTd>

                                    <MudTd DataLabel="Monate">
                                        @string.Join(", ", context.Months.OrderBy(x => x))
                                    </MudTd>

                                    <MudTd DataLabel="Regulär">
                                        @FormatRegularSummary(context)
                                    </MudTd>

                                    <MudTd DataLabel="Wöchentlich">
                                        @if (context.WeeklyOverrides.Any())
                                        {
                                            <MudList T="string" Dense="true">
                                                @foreach (var w in context.WeeklyOverrides.OrderBy(x => x.Day))
                                                {
                                                    <MudListItem T="string">
                                                        @($"{w.Day}: " +
                                                          (w.IsClosed ? "Geschlossen" :
                                                           $"{w.StartTime:hh\\:mm}-{w.EndTime:hh\\:mm}") +
                                                          (w.CapacityPerSlotOverride.HasValue ? $" | Kap: {w.CapacityPerSlotOverride}" : " | Kap: (Basis)"))
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        }
                                        else
                                        {
                                            <MudText>-</MudText>
                                        }
                                    </MudTd>

                                    <MudTd DataLabel="Datum">
                                        @if (context.DateOverrides.Any())
                                        {
                                            <MudList T="string" Dense="true">
                                                @foreach (var d in context.DateOverrides.OrderBy(x => x.Date))
                                                {
                                                    <MudListItem T="string">@d.ToString()</MudListItem>
                                                }
                                            </MudList>
                                        }
                                        else
                                        {
                                            <MudText>-</MudText>
                                        }
                                    </MudTd>

                                    <MudTd DataLabel="Aktionen">
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Edit"
                                                   OnClick="@(() => OnEditYear(context))">
                                            Bearbeiten
                                        </MudButton>

                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Error"
                                                   StartIcon="@Icons.Material.Filled.Delete"
                                                   OnClick="@(() => OnDeleteYear(context))">
                                            Löschen
                                        </MudButton>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudExpansionPanel>
                }
            </MudExpansionPanels>
        }
    </MudStack>

</MudPaper>

@code {

    private List<Service> _services = new();

    private WorkingScheduleRequestDto _model = new();

    private int _activeStep = 0;
    private bool _saving = false;

    private HashSet<int> _selectedMonths = new();

    private WeeklyOverrideDto _newWeekly = new();
    private DateOverrideDto _newDate = new();

    private bool _isEditingWeekly = false;
    private WeeklyOverrideDto? _editingWeeklyRef;

    private bool _isEditingDate = false;
    private DateOverrideDto? _editingDateRef;

    private List<WorkingScheduleOverviewItem> _overview = new();
    private bool _overviewLoading = true;

    // -------------------------------------------------
    // LOGIN-GUARD (Admin Services)
    // -------------------------------------------------
     protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        var auth = await EmployeeSession.EnsureAuthenticatedAsync();
        if (!auth.IsAuthenticated)
        {
            Navigation.NavigateTo("/employee/login", true);
            return;
        }

        var role = EmployeeSession.CurrentRole;
        if (role != EmployeeRole.ServiceChef && role != EmployeeRole.Admin)
        {
            Navigation.NavigateTo("/employee/home", true);
            return;
        }
    }


    private readonly Dictionary<int, string> _monthNames = new()
    {
        {1,"Januar"},{2,"Februar"},{3,"März"},{4,"April"},{5,"Mai"},{6,"Juni"},
        {7,"Juli"},{8,"August"},{9,"September"},{10,"Oktober"},{11,"November"},{12,"Dezember"}
    };

    private List<int> _years = new();
    private readonly List<DayOfWeek> _orderedDays = new()
    {
        DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday,
        DayOfWeek.Friday, DayOfWeek.Saturday, DayOfWeek.Sunday
    };

    protected override async Task OnInitializedAsync()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;

        _years = Enumerable.Range(DateTime.Now.Year - 1, 5).ToList();

        await LoadServicesAsync();
        await LoadOverviewAsync();

        PrefillCapacityFields();
    }

    private async Task LoadServicesAsync()
        => _services = await ServiceService.GetAllServicesAsync();

    private async Task LoadOverviewAsync()
    {
        _overviewLoading = true;
        _overview = await OverviewService.GetOverviewAsync();
        _overviewLoading = false;
    }

    private bool IsStep1Valid => _model.ServiceId > 0;
    private bool IsStep2Valid => IsStep1Valid && _model.Year > 0;
    private bool IsStep3Valid => IsStep2Valid && _selectedMonths.Any();
    private bool IsStep4Valid =>
        IsStep3Valid &&
        _model.RegularDays.Any() &&
        _model.StartTime.HasValue &&
        _model.EndTime.HasValue &&
        _model.StartTime.Value < _model.EndTime.Value;

    private void GoToStep(int step) => _activeStep = step;

    private Service? GetSelectedService()
        => _services.FirstOrDefault(s => s.Id == _model.ServiceId);

    private int? GetBaseCapacity()
        => GetSelectedService()?.CapacityPerSlot;

    private int GetEmployeeCount()
        => GetSelectedService()?.AssignedEmployees?.Count ?? 0;

    private int GetSlotDuration()
        => GetSelectedService()?.SlotDurationMinutes ?? 0;

    private async Task OnServiceChanged(int serviceId)
    {
        _model.ServiceId = serviceId;

        // UX: Wenn Service gewechselt wird -> Formular zurücksetzen (aber Service beibehalten)
        var keepServiceId = _model.ServiceId;
        ResetForm();
        _model.ServiceId = keepServiceId;

        PrefillCapacityFields();

      
    }

    private void PrefillCapacityFields()
    {
        var baseCap = GetBaseCapacity();
        var prefill = (baseCap.HasValue && baseCap.Value > 0) ? baseCap : null;

        _newWeekly.CapacityPerSlotOverride = prefill;
        _newDate.CapacityPerSlotOverride = prefill;
    }

    private void OnMonthsChanged(IEnumerable<int> values)
    {
        _selectedMonths = values.ToHashSet();
        _model.Months = _selectedMonths.ToHashSet(); // unsortiert ok – Backend nimmt Min/Max
    }

    private void OnRegularDayChanged(DayOfWeek day, bool value)
    {
        if (value)
            _model.RegularDays.Add(day);
        else
            _model.RegularDays.Remove(day);
    }

    // -----------------------------
    // WEEKLY: Add/Edit
    // -----------------------------
    private bool CanSubmitWeekly
    {
        get
        {
            if (!_isEditingWeekly && _model.WeeklyOverrides.Any(x => x.Day == _newWeekly.Day))
                return false;

            if (_newWeekly.IsClosed)
                return true;

            return _newWeekly.StartTime.HasValue &&
                   _newWeekly.EndTime.HasValue &&
                   _newWeekly.StartTime.Value < _newWeekly.EndTime.Value;
        }
    }

    private Task OnWeeklyClosedChanged(bool value)
    {
        _newWeekly.IsClosed = value;

        if (value)
        {
            _newWeekly.StartTime = null;
            _newWeekly.EndTime = null;
            _newWeekly.CapacityPerSlotOverride = null;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnDateClosedChanged(bool value)
    {
        _newDate.IsClosed = value;

        if (value)
        {
            _newDate.StartTime = null;
            _newDate.EndTime = null;
            _newDate.CapacityPerSlotOverride = null;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    private void BeginEditWeekly(WeeklyOverrideDto item)
    {
        _isEditingWeekly = true;
        _editingWeeklyRef = item;

        _newWeekly = new WeeklyOverrideDto
        {
            Day = item.Day,
            IsClosed = item.IsClosed,
            StartTime = item.StartTime,
            EndTime = item.EndTime,
            CapacityPerSlotOverride = item.CapacityPerSlotOverride
        };

        StateHasChanged();
    }

    private void CancelEditWeekly()
    {
        _isEditingWeekly = false;
        _editingWeeklyRef = null;

        _newWeekly = new WeeklyOverrideDto();
        PrefillCapacityFields();
    }

    private void SubmitWeekly()
    {
        var baseCap = GetBaseCapacity();
        int? capacityOverride = _newWeekly.CapacityPerSlotOverride;

        if (baseCap.HasValue && capacityOverride.HasValue && capacityOverride.Value == baseCap.Value)
            capacityOverride = null;

        if (_newWeekly.IsClosed)
        {
            _newWeekly.StartTime = null;
            _newWeekly.EndTime = null;
        }

        if (_isEditingWeekly && _editingWeeklyRef != null)
        {
            _editingWeeklyRef.IsClosed = _newWeekly.IsClosed;
            _editingWeeklyRef.StartTime = _newWeekly.IsClosed ? null : _newWeekly.StartTime;
            _editingWeeklyRef.EndTime = _newWeekly.IsClosed ? null : _newWeekly.EndTime;
            _editingWeeklyRef.CapacityPerSlotOverride = capacityOverride;

            CancelEditWeekly();
            return;
        }

        _model.WeeklyOverrides.Add(new WeeklyOverrideDto
        {
            Day = _newWeekly.Day,
            IsClosed = _newWeekly.IsClosed,
            StartTime = _newWeekly.IsClosed ? null : _newWeekly.StartTime,
            EndTime = _newWeekly.IsClosed ? null : _newWeekly.EndTime,
            CapacityPerSlotOverride = capacityOverride
        });

        _newWeekly = new WeeklyOverrideDto();
        PrefillCapacityFields();
    }

    private void RemoveWeeklyOverride(WeeklyOverrideDto item)
    {
        if (_isEditingWeekly && _editingWeeklyRef == item)
            CancelEditWeekly();

        _model.WeeklyOverrides.Remove(item);
    }

    // -----------------------------
    // DATE: Add/Edit
    // -----------------------------
    private bool CanSubmitDate
    {
        get
        {
            if (!_newDate.Date.HasValue)
                return false;

            if (!_isEditingDate &&
                _model.DateOverrides.Any(x => x.Date.HasValue && x.Date.Value.Date == _newDate.Date.Value.Date))
                return false;

            if (_newDate.IsClosed)
                return true;

            return _newDate.StartTime.HasValue &&
                   _newDate.EndTime.HasValue &&
                   _newDate.StartTime.Value < _newDate.EndTime.Value;
        }
    }

    private void BeginEditDate(DateOverrideDto item)
    {
        _isEditingDate = true;
        _editingDateRef = item;

        _newDate = new DateOverrideDto
        {
            Date = item.Date,
            IsClosed = item.IsClosed,
            StartTime = item.StartTime,
            EndTime = item.EndTime,
            CapacityPerSlotOverride = item.CapacityPerSlotOverride
        };

        StateHasChanged();
    }

    private void CancelEditDate()
    {
        _isEditingDate = false;
        _editingDateRef = null;

        _newDate = new DateOverrideDto();
        PrefillCapacityFields();
    }

    private void SubmitDate()
    {
        if (!_newDate.Date.HasValue)
            return;

        var baseCap = GetBaseCapacity();
        int? capacityOverride = _newDate.CapacityPerSlotOverride;

        if (baseCap.HasValue && capacityOverride.HasValue && capacityOverride.Value == baseCap.Value)
            capacityOverride = null;

        if (_newDate.IsClosed)
        {
            _newDate.StartTime = null;
            _newDate.EndTime = null;
        }

        if (_isEditingDate && _editingDateRef != null)
        {
            _editingDateRef.IsClosed = _newDate.IsClosed;
            _editingDateRef.StartTime = _newDate.IsClosed ? null : _newDate.StartTime;
            _editingDateRef.EndTime = _newDate.IsClosed ? null : _newDate.EndTime;
            _editingDateRef.CapacityPerSlotOverride = capacityOverride;

            CancelEditDate();
            return;
        }

        _model.DateOverrides.Add(new DateOverrideDto
        {
            Date = _newDate.Date.Value.Date,
            IsClosed = _newDate.IsClosed,
            StartTime = _newDate.IsClosed ? null : _newDate.StartTime,
            EndTime = _newDate.IsClosed ? null : _newDate.EndTime,
            CapacityPerSlotOverride = capacityOverride
        });

        _newDate = new DateOverrideDto();
        PrefillCapacityFields();
    }

    private void RemoveDateOverride(DateOverrideDto item)
    {
        if (_isEditingDate && _editingDateRef == item)
            CancelEditDate();

        _model.DateOverrides.Remove(item);
    }

    // -----------------------------
    // SAVE
    // -----------------------------
    private async Task SaveAsync()
    {
        _saving = true;

        try
        {
            _model.Months = _selectedMonths.ToHashSet(); 

            var ok = await WorkingScheduleService.GenerateScheduleAsync(_model);

            if (!ok)
            {
                Snackbar.Add("Fehler beim Speichern des Dienstplans.", Severity.Error);
                return;
            }

            Snackbar.Add("Dienstplan erfolgreich erstellt/aktualisiert.", Severity.Success);

            await LoadOverviewAsync();
            ResetForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void ResetForm()
    {
        var keepServiceId = _model.ServiceId;

        _activeStep = 0;
        _model = new WorkingScheduleRequestDto();
        _model.ServiceId = keepServiceId;

        _selectedMonths.Clear();

        CancelEditWeekly();
        CancelEditDate();

        _newWeekly = new WeeklyOverrideDto();
        _newDate = new DateOverrideDto();

        PrefillCapacityFields();
        StateHasChanged();
    }

    // -----------------------------
    // OVERVIEW: Edit/Delete (dein bestehender Flow)
    // -----------------------------
    private async Task OnDeleteYear(WorkingScheduleYearPlan year)
    {
        bool ok = await OverviewService.DeleteYearAsync(year.ServiceId, year.Year);

        if (ok)
        {
            Snackbar.Add("Jahresplan gelöscht.", Severity.Success);
            await LoadOverviewAsync();
        }
    }

    private async Task OnEditYear(WorkingScheduleYearPlan year)
    {
        _model = await CreateRequestFromYearPlan(year);
        _selectedMonths = _model.Months.ToHashSet();

        PrefillCapacityFields();

        _activeStep = 0;

        CancelEditWeekly();
        CancelEditDate();

        StateHasChanged();
    }

    private Task<WorkingScheduleRequestDto> CreateRequestFromYearPlan(WorkingScheduleYearPlan year)
    {
        var dto = new WorkingScheduleRequestDto
        {
            ServiceId = year.ServiceId,
            Year = year.Year,
            Months = year.Months.ToHashSet(),
            RegularDays = year.RegularDays,
            StartTime = year.RegularStartTime,
            EndTime = year.RegularEndTime
        };

        foreach (var w in year.WeeklyOverrides)
        {
            dto.WeeklyOverrides.Add(new WeeklyOverrideDto
            {
                Day = w.Day,
                IsClosed = w.IsClosed,
                StartTime = w.StartTime,
                EndTime = w.EndTime,
                CapacityPerSlotOverride = w.CapacityPerSlotOverride
            });
        }

        foreach (var d in year.DateOverrides)
        {
            dto.DateOverrides.Add(new DateOverrideDto
            {
                Date = d.Date,
                IsClosed = d.IsClosed,
                StartTime = d.StartTime,
                EndTime = d.EndTime,
                CapacityPerSlotOverride = d.CapacityPerSlotOverride
            });
        }

        return Task.FromResult(dto);
    }

    // -----------------------------
    // UI helpers
    // -----------------------------
    private string FormatMonths(IEnumerable<int> months)
    {
        var list = months?.OrderBy(x => x).ToList() ?? new List<int>();
        if (list.Count == 0) return "-";
        return string.Join(", ", list.Select(m => _monthNames.TryGetValue(m, out var name) ? name : m.ToString()));
    }

    private string FormatDays(IEnumerable<DayOfWeek> days)
    {
        var list = days?.OrderBy(d => _orderedDays.IndexOf(d)).ToList() ?? new List<DayOfWeek>();
        if (list.Count == 0) return "-";
        return string.Join(", ", list.Select(d => d.ToString()));
    }

    private string FormatRegularSummary(WorkingScheduleYearPlan plan)
    {
        if (plan.RegularHours == null || plan.RegularHours.Count == 0)
            return "-";

        var first = plan.RegularHours.First();
        bool consistent = plan.RegularHours.All(x => x.StartTime == first.StartTime && x.EndTime == first.EndTime);

        if (consistent)
        {
            var days = plan.RegularHours
                .Select(x => x.Day)
                .OrderBy(d => _orderedDays.IndexOf(d))
                .ToList();

            return $"{string.Join(", ", days)} | {first.StartTime:hh\\:mm} - {first.EndTime:hh\\:mm}";
        }

        return string.Join(" | ", plan.RegularHours.Select(r => r.ToString()));
    }

    private string GetPlannedRangeText()
    {
        if (_model.Year <= 0 || _selectedMonths.Count == 0)
            return "-";

        var fromMonth = _selectedMonths.Min();
        var toMonth = _selectedMonths.Max();

        return $"{fromMonth:00}/{_model.Year} bis {toMonth:00}/{_model.Year}";
    }

    private string FormatPlanRange(WorkingSchedulePlanDto p)
    {
        // erwartet DateOnly in DTO; falls DateTime: einfach ToString("dd.MM.yyyy") anpassen
        return $"{p.ValidFromDate:dd.MM.yyyy} – {p.ValidToDate:dd.MM.yyyy}";
    }
}
