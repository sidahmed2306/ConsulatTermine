@page "/employee/home"
@page "/employee/"

@using MudBlazor
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.UI.Authentication

@inject NavigationManager Navigation
@inject EmployeeSessionService EmployeeSession
@inject IEmployeeService EmployeeService

<MudContainer MaxWidth="MaxWidth.False"
              Class="d-flex justify-center align-center"
              Style="min-height: calc(100vh - 120px);">

    <MudPaper Elevation="1" Class="pa-8 text-center" Style="min-width:420px;">

        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Class="my-6" />
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                Lade Mitarbeiterdaten...
            </MudText>
        }
        else if (!string.IsNullOrWhiteSpace(_error))
        {
            <MudText Typo="Typo.h6" Color="Color.Error">
                @_error
            </MudText>
        }
        else
        {
            <MudText Typo="Typo.h3" Color="Color.Primary" GutterBottom="true">
                Willkommen ðŸ‘‹
            </MudText>

            <MudText Typo="Typo.h4" Class="mb-4">
                @_firstName @_lastName
            </MudText>

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                Ich wÃ¼nsche dir einen erfolgreichen und ruhigen Arbeitstag, @_firstName.
            </MudText>

            <MudText Typo="Typo.body1" Class="mt-3">
                Du bist heute genau richtig hier â€“ lass uns das gemeinsam sauber durchziehen.
            </MudText>
        }

    </MudPaper>

</MudContainer>

@code {

    private bool _loading = true;
    private string _firstName = "";
    private string _lastName = "";
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var auth = await EmployeeSession.EnsureAuthenticatedAsync();
            if (!auth.IsAuthenticated || auth.EmployeeId <= 0)
            {
                Navigation.NavigateTo("/employee/login", true);
                return;
            }

            var employee = await EmployeeService.GetEmployeeByIdAsync(auth.EmployeeId);
            if (employee is null)
            {
                _error = "Mitarbeiter nicht gefunden.";
                return;
            }

            _firstName = employee.FirstName;
            _lastName = employee.LastName;
        }
        catch
        {
            _error = "Unerwarteter Fehler beim Laden der Mitarbeiterdaten.";
        }
        finally
        {
            _loading = false;
        }
    }
}
