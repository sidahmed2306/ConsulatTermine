@page "/employee/dashboard"
@implements IDisposable

@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Domain.Enums
@using ConsulatTermine.Application.Interfaces
@using ConsulatTermine.UI.Authentication
@using MudBlazor
@using Blazored.SessionStorage

@inject IAppointmentService AppointmentService
@inject EmployeeSessionService EmployeeSession
@inject IWaitingRoomNotifier WaitingRoomNotifier
@inject ISessionStorageService Session
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">

    @if (_loading)
    {
        <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="mt-8">
            <MudProgressCircular Indeterminate />
            <MudText>Dashboard wird geladenâ€¦</MudText>
        </MudStack>
    }
    else
    {
        <MudGrid>

            <!-- LINKS -->
            <MudItem xs="12" md="9">

                <MudPaper Class="pa-4 mb-3">
                    <MudText Typo="Typo.h5">Dashboard â€“ @_serviceName</MudText>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                        Zimmer @_room Â· BÃ¼ro @_office Â· @DateTime.Today.ToString("dd.MM.yyyy")
                    </MudText>
                </MudPaper>

                <MudPaper Class="pa-4 mb-3">
                    <MudStack Direction="Row" Spacing="2">

                        <MudButton Color="Color.Primary"
                                   Disabled="@(!_canNext)"
                                   OnClick="NextAsync">
                            â–¶ NEXT
                        </MudButton>

                        <MudButton Color="Color.Warning"
                                   Variant="Variant.Outlined"
                                   Disabled="@(!_hasMyInProgress)"
                                   OnClick="RecallAsync">
                            ðŸ”” NOCHMAL AUFRUFEN
                        </MudButton>

                        <MudButton Color="Color.Info"
                                   Disabled="@(!_hasMyInProgress)"
                                   OnClick="ArrivedAsync">
                            ðŸ‘¤ IST DA
                        </MudButton>

                        <MudButton Color="Color.Success"
                                   Disabled="@(!_hasMyInProgress)"
                                   OnClick="CompleteAsync">
                            âœ… TERMIN ABSCHLIESSEN
                        </MudButton>

                    </MudStack>
                </MudPaper>

                <MudTable Items="_appointments" Dense Hover>
                    <HeaderContent>
                        <MudTh>Uhrzeit</MudTh>
                        <MudTh>Name</MudTh>
                        <MudTh>Status</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>@context.Date.ToString("HH:mm")</MudTd>
                        <MudTd>@context.FullName</MudTd>
                        <MudTd>
                            <MudChip T="String" Color="@GetStatusColor(context)" Size="Size.Small">
                                @GetStatusText(context)
                            </MudChip>
                        </MudTd>
                    </RowTemplate>
                </MudTable>

            </MudItem>

            <!-- RECHTS -->
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6">Statistik</MudText>
                    <MudDivider />
                    <MudText>Gesamt: @_appointments.Count</MudText>
                    <MudText>Wartend: @_appointments.Count(a => a.Status == AppointmentStatus.Booked)</MudText>
                    <MudText>Bei mir: @_appointments.Count(a =>
                        a.Status == AppointmentStatus.InProgress &&
                        a.CurrentEmployeeId == _employeeId)</MudText>
                </MudPaper>
            </MudItem>

        </MudGrid>
    }

</MudContainer>

@code {
    private bool _loading = true;
    private bool _initialized;
    private bool _disposed;

    private int _employeeId;
    private int _serviceId;

    private string _serviceName = "";
    private string _office = "";
    private string _room = "";

    private List<Appointment> _appointments = new();
    private Appointment? _myInProgress;

    private readonly SemaphoreSlim _sync = new(1, 1);

    // âœ… WAR FEHLEND
    private bool _hasMyInProgress => _myInProgress != null;

    private bool _canNext =>
        _initialized &&
        _myInProgress == null &&
        _appointments.Any(a => a.Status == AppointmentStatus.Booked);

    protected override Task OnInitializedAsync()
    {
        WaitingRoomNotifier.OnChanged += HandleChanged;
        return Task.CompletedTask;
    }

    // âœ… SIGNATUR KORRIGIERT (Reason + AppointmentId)
    private void HandleChanged(WaitingRoomChangeReason _, int? __)
    {
        if (_disposed) return;

    InvokeAsync(async () =>
{
    if (_disposed || !_initialized) return;

    await WithLockAsync(async () =>
    {
        await LoadAsync();
    });

    StateHasChanged();
});

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _disposed) return;

        var auth = await EmployeeSession.EnsureAuthenticatedAsync();
        if (!auth.IsAuthenticated)
        {
            Navigation.NavigateTo("/employee/login", true);
            return;
        }

        _employeeId = auth.EmployeeId;

        var activeService = await EmployeeSession.GetActiveServiceAsync();
        if (activeService == null)
        {
            Navigation.NavigateTo("/employee/select-service", true);
            return;
        }

        _serviceId = activeService.Value;

        _office = await Session.GetItemAsync<string>("OfficeName") ?? "";
        _room = await Session.GetItemAsync<string>("RoomName") ?? "";
        _serviceName = await Session.GetItemAsync<string>("ServiceName") ?? _serviceName;

        await WithLockAsync(async () => await LoadAsync());

        _initialized = true;
        _loading = false;

        StateHasChanged();
    }

    private async Task WithLockAsync(Func<Task> work)
    {
        await _sync.WaitAsync();
        try
        {
            if (_disposed) return;
            await work();
        }
        finally
        {
            _sync.Release();
        }
    }

    private async Task LoadAsync()
    {
        _appointments = await AppointmentService
            .GetAppointmentsForServiceOnDateAsync(_serviceId, DateTime.Today);

        _myInProgress = _appointments.FirstOrDefault(a =>
            (a.Status == AppointmentStatus.InProgress ||
             a.Status == AppointmentStatus.AtDesk) &&
            a.CurrentEmployeeId == _employeeId);
    }

    private async Task NextAsync()
    {
        if (!_initialized) return;

        await WithLockAsync(async () =>
        {
            await LoadAsync();

            var next = _appointments
                .Where(a => a.Status == AppointmentStatus.Booked)
                .OrderBy(a => a.Date)
                .FirstOrDefault();

            if (next == null) return;

            var ok = await AppointmentService.StartProcessingAsync(next.Id, _employeeId);
            if (!ok) return;

            WaitingRoomNotifier.SetWorkplace(next.Id, _office, _room);
            WaitingRoomNotifier.Notify(WaitingRoomChangeReason.Call, next.Id);

         
        });

        StateHasChanged();
    }

    private Task RecallAsync()
    {
        if (_myInProgress == null) return Task.CompletedTask;

        WaitingRoomNotifier.Notify(
            WaitingRoomChangeReason.Recall,
            _myInProgress.Id
        );

        return Task.CompletedTask;
    }

    private async Task ArrivedAsync()
    {
        if (_myInProgress == null) return;

        await AppointmentService.HideFromWaitingRoomAsync(
            _myInProgress.Id,
            _employeeId
        );

     
        StateHasChanged();
    }

    private async Task CompleteAsync()
    {
        if (_myInProgress == null) return;

        await AppointmentService.CompleteAsync(
            _myInProgress.Id,
            _employeeId
        );

        WaitingRoomNotifier.Notify();
      
        StateHasChanged();
    }

    // âœ… WAR FEHLEND
    private static Color GetStatusColor(Appointment a) => a.Status switch
    {
        AppointmentStatus.InProgress => Color.Warning,
        AppointmentStatus.AtDesk     => Color.Info,
        AppointmentStatus.Completed  => Color.Success,
        _                            => Color.Default
    };

    // âœ… WAR FEHLEND
    private string GetStatusText(Appointment a)
    {
        if (a.Status == AppointmentStatus.InProgress && a.CurrentEmployeeId == _employeeId)
            return "Bei mir";

        if (a.Status == AppointmentStatus.AtDesk && a.CurrentEmployeeId == _employeeId)
            return "Ist da";

        return a.Status.ToString();
    }

    public void Dispose()
    {
        _disposed = true;
        WaitingRoomNotifier.OnChanged -= HandleChanged;
        _sync.Dispose();
    }
}
