@page "/employee/dashboard"

@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Application.DTOs
@using ConsulatTermine.Application.Interfaces
@using MudBlazor

@inherits ConsulatTermine.UI.Authentication.EmployeeProtectedComponentBase

@inject IServiceService ServiceService
@inject IAppointmentService AppointmentService
@inject ConsulatTermine.UI.Authentication.EmployeeSessionService EmployeeSession

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">

    <!-- Service Header -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h5">@(_service?.Name ?? "Service")</MudText>
        <MudText Typo="Typo.subtitle2">Datum: @_today.ToString("dd.MM.yyyy")</MudText>
    </MudPaper>

    <!-- NEXT Button (zentriert) -->
    <MudPaper Class="pa-6 mb-6">
        <MudStack Row="true" Justify="Justify.Center">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Disabled="@(!_appointments.Any())"
                       OnClick="CallNext">
                Nächsten Termin aufrufen
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Main Content -->
    <MudGrid>

        <!-- Termine Tabelle -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-2">Termine heute</MudText>

                <MudTable Items="_appointments" Dense Hover>
                    <HeaderContent>
                        <MudTh>Nachname</MudTh>
                        <MudTh>Vorname</MudTh>
                        <MudTh>Uhrzeit</MudTh>
                        <MudTh>Service</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>@GetLastName(context.FullName)</MudTd>
                        <MudTd>@GetFirstName(context.FullName)</MudTd>
                        <MudTd>@context.Date.ToString("HH:mm")</MudTd>
                        <MudTd>@(_service?.Name ?? "-")</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>

        <!-- Statistik -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-2">Statistik</MudText>

                <MudList T="string" Dense>
                    <MudListItem T="string">
                        <MudText>Termine gesamt:</MudText>
                        <MudText Typo="Typo.subtitle1">@_appointments.Count</MudText>
                    </MudListItem>

                    <MudListItem T="string">
                        <MudText>Vergangen:</MudText>
                        <MudText Typo="Typo.subtitle1">@_pastCount</MudText>
                    </MudListItem>

                    <MudListItem T="string">
                        <MudText>Kommend:</MudText>
                        <MudText Typo="Typo.subtitle1">@_upcomingCount</MudText>
                    </MudListItem>

                    <MudDivider Class="my-2" />

                    <MudListItem T="string">
                        <MudText>Nächster Termin:</MudText>
                        <MudText Typo="Typo.subtitle1">@_nextTimeLabel</MudText>
                    </MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>

    </MudGrid>

</MudContainer>

@code {
    private readonly DateTime _today = DateTime.Today;

    // Bei dir liefert ServiceService.GetByIdAsync ein ServiceDto → daher ServiceDto verwenden
    private ServiceDto? _service;

    private List<Appointment> _appointments = new();
    private bool _loaded;

    private int _pastCount;
    private int _upcomingCount;
    private string _nextTimeLabel = "-";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (!firstRender || _loaded || CurrentEmployeeId <= 0)
            return;

        _loaded = true;

        // Aktiven Service aus Session holen
        var serviceId = await EmployeeSession.GetActiveServiceAsync();
        if (serviceId == null)
        {
            Navigation.NavigateTo("/employee/select-service", replace: true);
            return;
        }

        // Service laden (DTO)
        _service = await ServiceService.GetByIdAsync(serviceId.Value);
        if (_service == null)
        {
            Navigation.NavigateTo("/employee/select-service", replace: true);
            return;
        }

        // Termine für HEUTE + diesen Service (ohne CheckedIn Filter – Version 1)
        _appointments = await AppointmentService.GetAppointmentsForServiceOnDateAsync(
            serviceId.Value,
            _today
        );

        RecalcStats();
        StateHasChanged();
    }

    private void RecalcStats()
    {
        var now = DateTime.Now;

        _pastCount = _appointments.Count(a => a.Date < now);
        _upcomingCount = _appointments.Count(a => a.Date >= now);

        var next = _appointments
            .Where(a => a.Date >= now)
            .OrderBy(a => a.Date)
            .FirstOrDefault();

        _nextTimeLabel = next == null ? "-" : next.Date.ToString("HH:mm");
    }

    // Platzhalter – NEXT-Logik kommt in BLOCK S6
    private Task CallNext()
    {
        // später: nächsten Termin bestimmen + Status/Anzeige aktualisieren
        return Task.CompletedTask;
    }

    private static string GetFirstName(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "-";

        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length <= 1 ? parts[0] : string.Join(' ', parts.Take(parts.Length - 1));
    }

    private static string GetLastName(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "-";

        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length == 1 ? parts[0] : parts[^1];
    }
}
