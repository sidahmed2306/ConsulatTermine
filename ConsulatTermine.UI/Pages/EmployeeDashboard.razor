@page "/employee/dashboard/{ServiceId:int}"

@using ConsulatTermine.Domain.Entities
@using ConsulatTermine.Application.Interfaces
@using MudBlazor

@inject IAppointmentService AppointmentService
@inject IServiceService ServiceService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">

    <!-- Service Header -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h5">@(_service?.Name ?? $"Service #{ServiceId}")</MudText>
        <MudText Typo="Typo.subtitle2">Datum: @_today.ToString("dd.MM.yyyy")</MudText>
    </MudPaper>

    <!-- NEXT Button (zentriert) -->
    <MudPaper Class="pa-6 mb-6">
        <MudStack Row="true" Justify="Justify.Center">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Disabled="@(!_appointments.Any())"
                       OnClick="CallNext">
                Nächsten Termin aufrufen
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Main Content -->
    <MudGrid>

        <!-- Termine Tabelle -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-2">Termine heute</MudText>

                <MudTable Items="_appointments" Dense Hover>
                    <HeaderContent>
                        <MudTh>Nachname</MudTh>
                        <MudTh>Vorname</MudTh>
                        <MudTh>Uhrzeit</MudTh>
                        <MudTh>Service</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>@GetLastName(context.FullName)</MudTd>
                        <MudTd>@GetFirstName(context.FullName)</MudTd>
                        <MudTd>@context.Date.ToString("HH:mm")</MudTd>
                        <MudTd>@(_service?.Name ?? "-")</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>

        <!-- Statistik (ohne Status-Logik) -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-2">Statistik</MudText>

                <MudList T="string" Dense>
                    <MudListItem T="string">
                        <MudText>Termine gesamt:</MudText>
                        <MudText Typo="Typo.subtitle1">@_appointments.Count</MudText>
                    </MudListItem>

                    <MudListItem T="string">
                        <MudText>Vergangen:</MudText>
                        <MudText Typo="Typo.subtitle1">@_pastCount</MudText>
                    </MudListItem>

                    <MudListItem T="string">
                        <MudText>Kommend:</MudText>
                        <MudText Typo="Typo.subtitle1">@_upcomingCount</MudText>
                    </MudListItem>

                    <MudDivider Class="my-2" />

                    <MudListItem T="string">
                        <MudText>Nächster Termin:</MudText>
                        <MudText Typo="Typo.subtitle1">@_nextTimeLabel</MudText>
                    </MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>

    </MudGrid>

</MudContainer>

@code {
    [Parameter] public int ServiceId { get; set; }

    private Service? _service;
    private List<Appointment> _appointments = new();
    private readonly DateTime _today = DateTime.Today;

    private int _pastCount;
    private int _upcomingCount;
    private string _nextTimeLabel = "-";

    protected override async Task OnInitializedAsync()
    {
        _service = await ServiceService.GetServiceByIdAsync(ServiceId);

        _appointments = await AppointmentService
            .GetAppointmentsForServiceOnDateAsync(ServiceId, _today);

        // Statistik rein zeitbasiert (Version 1 – ohne Status/CheckedIn)
        var now = DateTime.Now;
        _pastCount = _appointments.Count(a => a.Date < now);
        _upcomingCount = _appointments.Count - _pastCount;

        var next = _appointments
            .Where(a => a.Date >= now)
            .OrderBy(a => a.Date)
            .FirstOrDefault();

        _nextTimeLabel = next == null ? "-" : next.Date.ToString("HH:mm");

        // Optional: immer sortiert anzeigen
        _appointments = _appointments.OrderBy(a => a.Date).ToList();
    }

    private async Task CallNext()
    {
        var next = await AppointmentService
            .GetNextAppointmentForServiceOnDateAsync(ServiceId, _today);

        if (next != null)
        {
            // Status-Handling + Wartezimmer-Display folgt in Version 2
            Navigation.NavigateTo($"/employee/call/{next.Id}");
        }
    }

    // Appointment speichert nur FullName – wir leiten Vor-/Nachname für die Tabelle ab.
    private static string GetLastName(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "-";

        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length == 0 ? "-" : parts[^1];
    }

    private static string GetFirstName(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "-";

        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length <= 1)
            return parts.Length == 1 ? parts[0] : "-";

        return string.Join(' ', parts.Take(parts.Length - 1));
    }
}
