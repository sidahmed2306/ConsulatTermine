@page "/employee/change-password/{EmployeeId:int}"

@using MudBlazor
@inject NavigationManager Navigation
@inject ConsulatTermine.Application.Interfaces.IEmployeeAuthService AuthService

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudCard>
        <MudCardContent>

            <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
                Passwort ändern
            </MudText>

            <MudForm @ref="_form" @bind-IsValid="_isValid">

                <MudTextField T="string"
                              Label="Neues Passwort"
                              @bind-Value="_newPassword"
                              InputType="@_passwordInputType"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              Required="true"
                              RequiredError="Passwort ist erforderlich"
                              Variant="Variant.Outlined" />

                <MudTextField T="string"
                              Label="Passwort bestätigen"
                              @bind-Value="_confirmPassword"
                              InputType="@_passwordInputType"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_passwordIcon"
                              OnAdornmentClick="TogglePasswordVisibility"
                              Required="true"
                              RequiredError="Bestätigung ist erforderlich"
                              Variant="Variant.Outlined"
                              Class="mt-4" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudText Color="Color.Error" Class="mt-2">@_errorMessage</MudText>
                }

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="!_isValid"
                           OnClick="PerformChangePassword"
                           Class="mt-6"
                           FullWidth="true">
                    Passwort speichern
                </MudButton>

            </MudForm>

        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [Parameter]
    public int EmployeeId { get; set; }

    private MudForm? _form;
    private bool _isValid;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _errorMessage = string.Empty;

    // Passwort sichtbar/unsichtbar
    private bool _showPassword;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        if (_showPassword)
        {
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private async Task PerformChangePassword()
    {
        if (_form is null)
            return;

        await _form.Validate();

        if (!_isValid)
            return;

        _errorMessage = string.Empty;

        if (_newPassword != _confirmPassword)
        {
            _errorMessage = "Die Passwörter stimmen nicht überein.";
            return;
        }

        // Backend aufrufen
        bool success = await AuthService.ChangePasswordAsync(EmployeeId, _newPassword);

        if (!success)
        {
            _errorMessage = "Passwort konnte nicht gespeichert werden.";
            return;
        }

        // Zur Mitarbeiter-Startseite weiterleiten
        Navigation.NavigateTo("/employee/dashboard");
    }
}
